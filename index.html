<script>
const ORDER_TO = "info@abuelatata.com";

const SIZE_MAP = {
  baby: ["3M","6M","9M","12M","18M","2A","3A","4A"],
  kid:  ["12M","18M","2A","3A","4A","5A","6A","8A","10A","12A"]
};

const qs = (s)=>document.querySelector(s);
const el = (id)=>document.getElementById(id);

function getSizesByRef(ref){
  if(ref.startsWith("12") || ref.startsWith("13") || ref.startsWith("11")) return SIZE_MAP.baby;
  if(ref.startsWith("25") || ref.startsWith("43") || ref.startsWith("22")) return SIZE_MAP.kid;
  return SIZE_MAP.kid; // 24 u otros: por defecto kid (luego lo ajustamos)
}

el("refInput").addEventListener("keydown", function(e){
  if(e.key==="Enter"){
    e.preventDefault();
    addProduct(this.value.trim());
    this.value="";
  }
});

function addProduct(ref){
  if(!ref) return;

  // evita duplicados
  const exists = Array.from(document.querySelectorAll(".product"))
    .some(p => (p.dataset.ref||"") === ref);
  if(exists) return;

  const sizes = getSizesByRef(ref);
  const div = document.createElement("div");
  div.className="product";
  div.dataset.ref = ref;

  div.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <strong>${ref}</strong>
      <button type="button" onclick="this.closest('.product').remove()">Quitar</button>
    </div>
    <div class="sizes"></div>
  `;

  const sizesDiv = div.querySelector(".sizes");
  sizes.forEach(s=>{
    const box=document.createElement("div");
    box.className="sizeBox";
    box.innerHTML=`<span>${s}</span><input type="number" min="0" value="0" data-size="${s}">`;
    sizesDiv.appendChild(box);
  });

  el("products").appendChild(div);
}

function buildOrderText(){
  const today = new Date().toLocaleDateString("es-ES");

  const client = {
    fiscalName: el("fiscalName").value.trim(),
    taxId:      el("taxId").value.trim(),
    shopName:   el("shopName").value.trim(),
    email:      el("email").value.trim(),
    phone:      el("phone").value.trim(),
    address:    el("address").value.trim(),
    city:       el("city").value.trim(),
    zip:        el("zip").value.trim(),
    province:   el("province").value.trim(),
    notes:      el("notes").value.trim(),
  };

  let lines = [];
  document.querySelectorAll(".product").forEach(p=>{
    const ref = p.dataset.ref || "";
    p.querySelectorAll("input[type=number]").forEach(inp=>{
      const qty = Number(inp.value || "0");
      if(qty > 0){
        lines.push(`${ref} - ${inp.dataset.size}: ${qty}`);
      }
    });
  });

  return `PEDIDO INVIERNO AW26/27 — ABUELA TATA
Fecha: ${today}

DATOS CLIENTE
Nombre fiscal: ${client.fiscalName}
NIF/CIF: ${client.taxId}
Tienda: ${client.shopName}
Email: ${client.email}
Teléfono: ${client.phone}
Dirección: ${client.address}
CP / Ciudad: ${client.zip} ${client.city}
Provincia: ${client.province}

PEDIDO:
${lines.length ? lines.join("\n") : "(Sin líneas de pedido. Añade cantidades.)"}

Notas:
${client.notes || "-"}

All the best,
Abuela Tata
`;
}

function sendEmail(){
  const clientEmail = el("email").value.trim();
  if(!clientEmail){
    alert("Debes introducir el email del cliente (obligatorio).");
    return;
  }

  // comprobar que haya al menos una cantidad
  const hasQty = Array.from(document.querySelectorAll(".product input[type=number]"))
    .some(inp => Number(inp.value||"0") > 0);

  if(!hasQty){
    alert("No hay cantidades en el pedido.");
    return;
  }

  const shop = el("shopName").value.trim() || el("fiscalName").value.trim() || "Cliente";
  const dateStr = new Date().toLocaleDateString("es-ES");
  const subject = `Pedido Invierno AW26/27 — ${shop} — ${dateStr}`;
  const body = buildOrderText();

  const mailto =
    `mailto:${encodeURIComponent(ORDER_TO)}` +
    `?cc=${encodeURIComponent(clientEmail)}` +
    `&subject=${encodeURIComponent(subject)}` +
    `&body=${encodeURIComponent(body)}`;

  window.location.href = mailto;
}

function downloadPDF(){
  // abre una ventana imprimible y el cliente guarda como PDF
  const win = window.open("", "_blank");
  const text = buildOrderText()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

  win.document.write(`
    <html><head><title>Pedido Abuela Tata</title>
    <style>body{font-family:Arial;padding:30px} pre{white-space:pre-wrap;font-size:12px}</style>
    </head><body>
      <pre>${text}</pre>
      <script>window.print();<\/script>
    </body></html>
  `);
  win.document.close();
}

function saveDraft(){
  const payload = {
    client: {
      fiscalName: el("fiscalName").value,
      taxId: el("taxId").value,
      shopName: el("shopName").value,
      email: el("email").value,
      phone: el("phone").value,
      address: el("address").value,
      city: el("city").value,
      zip: el("zip").value,
      province: el("province").value,
      notes: el("notes").value
    },
    products: Array.from(document.querySelectorAll(".product")).map(p => ({
      ref: p.dataset.ref,
      qty: Array.from(p.querySelectorAll("input[type=number]")).reduce((acc,inp)=>{
        const n = Number(inp.value||"0");
        if(n>0) acc[inp.dataset.size]=n;
        return acc;
      },{})
    }))
  };
  localStorage.setItem("pedidoInviernoDraft", JSON.stringify(payload));
  alert("Borrador guardado ✅");
}

function loadDraft(){
  const raw = localStorage.getItem("pedidoInviernoDraft");
  if(!raw){ alert("No hay borrador guardado."); return; }

  const data = JSON.parse(raw);

  // cliente
  if(data.client){
    el("fiscalName").value = data.client.fiscalName || "";
    el("taxId").value = data.client.taxId || "";
    el("shopName").value = data.client.shopName || "";
    el("email").value = data.client.email || "";
    el("phone").value = data.client.phone || "";
    el("address").value = data.client.address || "";
    el("city").value = data.client.city || "";
    el("zip").value = data.client.zip || "";
    el("province").value = data.client.province || "";
    el("notes").value = data.client.notes || "";
  }

  // productos
  el("products").innerHTML = "";
  (data.products || []).forEach(p=>{
    if(!p.ref) return;
    addProduct(p.ref);
    const card = Array.from(document.querySelectorAll(".product")).find(x=>x.dataset.ref===p.ref);
    if(card && p.qty){
      card.querySelectorAll("input[type=number]").forEach(inp=>{
        const v = p.qty[inp.dataset.size];
        if(v!=null) inp.value = String(v);
      });
    }
  });

  alert("Borrador cargado ✅");
}

// Para ver errores fácilmente
window.addEventListener("error", (e)=>{
  alert("Error en la app: " + (e.message || e.error));
});
</script>
