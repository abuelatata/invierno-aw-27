<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Abuela Tata Â· Invierno AW 26/27 Â· Pedidos</title>

  <style>
    :root{
      --bg:#f6f8f7;
      --card:#ffffff;
      --ink:#102a2a;
      --muted:#5c6b6b;
      --brand:#8fcfc5;      /* verde agua */
      --brand2:#6bbeb1;
      --line:rgba(16,42,42,.12);
      --shadow:0 8px 30px rgba(16,42,42,.08);
      --radius:16px;
      --radius2:12px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg, #ffffff 0%, var(--bg) 32%, var(--bg) 100%);
      -webkit-font-smoothing:antialiased;
      padding-bottom:96px; /* espacio para barra total */
    }

    header{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }

    .topbar{
      max-width:1100px;
      margin:0 auto;
      padding:14px 14px 12px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:220px;
    }
    .badge{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%);
      box-shadow: 0 10px 22px rgba(107,190,177,.25);
    }
    .brand h1{
      font-size:15px;
      line-height:1.15;
      margin:0;
      letter-spacing:.2px;
    }
    .brand small{
      display:block;
      color:var(--muted);
      font-weight:500;
      margin-top:2px;
    }

    .search{
      flex:1;
      min-width:240px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    .search input{
      width:min(520px, 100%);
      padding:12px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-size:14px;
    }
    .search input:focus{
      border-color:rgba(143,207,197,.65);
      box-shadow:0 0 0 4px rgba(143,207,197,.18);
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding:14px;
    }

    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin:10px 2px 14px;
      color:var(--muted);
      font-size:13px;
    }
    .pill{
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow:0 4px 14px rgba(16,42,42,.06);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }

    .card{
      grid-column: span 12;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    @media (min-width: 820px){
      .card{ grid-column: span 6; }
    }
    @media (min-width: 1080px){
      .card{ grid-column: span 4; }
    }

    .cardTop{
      display:flex;
      gap:12px;
      padding:12px;
      border-bottom:1px solid var(--line);
    }

    .thumb{
      width:88px; height:88px;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(143,207,197,.25), rgba(107,190,177,.18));
      border:1px solid rgba(16,42,42,.10);
      overflow:hidden;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb .ph{
      font-weight:800;
      color:rgba(16,42,42,.55);
      letter-spacing:.5px;
      font-size:13px;
      text-align:center;
      padding:10px;
    }

    .info{
      min-width:0;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-top:2px;
    }

    .row1{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .ref{
      font-weight:800;
      font-size:14px;
      letter-spacing:.3px;
    }
    .name{
      font-size:13px;
      color:var(--muted);
      line-height:1.25;
      margin-top:2px;
      max-height:2.5em;
      overflow:hidden;
    }
    .price{
      font-weight:900;
      color:var(--ink);
      font-size:14px;
      background:rgba(143,207,197,.22);
      border:1px solid rgba(143,207,197,.35);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .sizes{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .sizesHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }

    .sizesGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .sizeLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
    }

    .sizeTag{
      font-weight:800;
      font-size:13px;
      letter-spacing:.2px;
      min-width:54px;
    }

    .stepper{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .btn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(16,42,42,.14);
      background:linear-gradient(180deg, #fff 0%, #f7fbfa 100%);
      box-shadow: 0 6px 16px rgba(16,42,42,.08);
      font-size:20px;
      font-weight:900;
      color:var(--ink);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.98); }
    .qty{
      width:54px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(16,42,42,.14);
      text-align:center;
      font-weight:900;
      font-size:14px;
      outline:none;
      background:#fff;
    }

    .lineTotal{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px 12px;
      border-top:1px dashed rgba(16,42,42,.14);
      color:var(--muted);
      font-size:13px;
    }
    .lineTotal strong{ color:var(--ink); }

    /* Barra fija abajo */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      z-index:60;
    }
    .bottomInner{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .totals{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:13px;
    }
    .totals .big{
      color:var(--ink);
      font-weight:1000;
      font-size:16px;
      letter-spacing:.2px;
      background:rgba(143,207,197,.22);
      border:1px solid rgba(143,207,197,.35);
      padding:8px 12px;
      border-radius:999px;
      white-space:nowrap;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .primary{
      border:none;
      background:linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%);
      color:#fff;
      font-weight:900;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(107,190,177,.25);
      -webkit-tap-highlight-color: transparent;
    }
    .secondary{
      border:1px solid rgba(16,42,42,.14);
      background:#fff;
      color:var(--ink);
      font-weight:900;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(16,42,42,.42);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:80;
    }
    .modal{
      width:min(900px, 100%);
      max-height:78vh;
      background:#fff;
      border-radius:18px 18px 0 0;
      border:1px solid var(--line);
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.9);
    }
    .modalHead strong{ font-size:14px; }
    .modalBody{ padding:12px 14px; }
    textarea{
      width:100%;
      height:48vh;
      border-radius:14px;
      border:1px solid var(--line);
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12.5px;
      outline:none;
    }
    .modalFoot{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background:#fff;
    }

    .noteErr{
      margin:14px 0 0;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(180,0,0,.25);
      background:rgba(255,0,0,.06);
      color:#7a1111;
      font-size:13px;
      display:none;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="badge" aria-hidden="true"></div>
        <div>
          <h1>Abuela Tata Â· Invierno AW 26/27</h1>
          <small>Pedidos Â· Selector de tallas (mÃ³vil pro)</small>
        </div>
      </div>

      <div class="search">
        <input id="q" type="search" placeholder="Buscar por referencia o nombreâ€¦" autocomplete="off" />
      </div>
    </div>
  </header>

  <main>
    <div class="meta">
      <div class="pill">ðŸ“¦ Productos: <strong id="count">0</strong></div>
      <div class="pill">ðŸ§¾ LÃ­neas con cantidades: <strong id="lines">0</strong></div>
    </div>

    <div id="err" class="noteErr"></div>

    <div class="grid" id="grid"></div>
  </main>

  <div class="bottomBar">
    <div class="bottomInner">
      <div class="totals">
        <span>Unidades: <strong id="u">0</strong></span>
        <span class="big">Total: <span id="t">0,00</span> â‚¬</span>
      </div>
      <div class="actions">
        <button class="secondary" id="btnClear" type="button">Vaciar</button>
        <button class="primary" id="btnResume" type="button">Resumen pedido</button>
      </div>
    </div>
  </div>

  <!-- Modal resumen -->
  <div class="modalBack" id="mb">
    <div class="modal">
      <div class="modalHead">
        <strong>Resumen del pedido</strong>
        <button class="secondary" id="btnClose" type="button">Cerrar</button>
      </div>
      <div class="modalBody">
        <textarea id="resume" readonly></textarea>
      </div>
      <div class="modalFoot">
        <button class="secondary" id="btnCopy" type="button">Copiar</button>
        <button class="primary" id="btnClose2" type="button">Listo</button>
      </div>
    </div>
  </div>

  <script>
    // ----- Reglas de tallas (tus familias) -----
    const SIZES_BEBE = ["3m","6m","9m","18m","2a","3a","4a"];
    const SIZES_NINO = ["12m","18m","2a","3a","4a","5a","6a","8a","10a","12a"];
    const SIZES_UNICA = ["ÃšNICA"];

    function familyFromRef(ref){
      const s = String(ref || "").trim();
      if (s.length < 2) return "";
      return s.slice(0,2);
    }

    function sizesForFamily(fam){
      if (["12","13","31","30"].includes(fam)) return SIZES_BEBE;
      if (["25","22","43"].includes(fam)) return SIZES_NINO;
      if (["08"].includes(fam)) return SIZES_UNICA;
      // Por defecto (para no dejar vacÃ­o): niÃ±o
      return SIZES_NINO;
    }

    // ----- Estado del pedido -----
    // order[ref][size] = qty
    const order = Object.create(null);

    function getQty(ref, size){
      return (order[ref] && order[ref][size]) ? order[ref][size] : 0;
    }
    function setQty(ref, size, qty){
      if (!order[ref]) order[ref] = Object.create(null);
      order[ref][size] = Math.max(0, Number(qty) || 0);
      if (order[ref][size] === 0) delete order[ref][size];
      // si se queda vacÃ­o el objeto, lo limpiamos
      if (Object.keys(order[ref]).length === 0) delete order[ref];
      refreshTotals();
    }

    function formatEUR(n){
      const v = Number(n) || 0;
      return v.toLocaleString("es-ES", {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    // ----- Carga de tarifa.json -----
    const grid = document.getElementById("grid");
    const q = document.getElementById("q");
    const countEl = document.getElementById("count");
    const linesEl = document.getElementById("lines");
    const errEl = document.getElementById("err");

    let productos = [];

    async function loadTarifa(){
      try{
        errEl.style.display = "none";
        // cache-busting para GitHub Pages
        const url = "./data/tarifa.json?v=" + Date.now();
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) throw new Error("No puedo leer tarifa.json (HTTP " + res.status + ").");
        const data = await res.json();

        if(!Array.isArray(data)) throw new Error("tarifa.json debe ser un array [ {ref,name,price}, ... ].");

        // Normalizamos campos
        productos = data
          .filter(x => x && (x.ref || x.name))
          .map(x => ({
            ref: String(x.ref ?? "").trim(),
            name: String(x.name ?? "").trim(),
            price: Number(x.price ?? 0)
          }))
          .filter(x => x.ref.length > 0);

        countEl.textContent = productos.length;
        render();
      }catch(e){
        errEl.textContent = "âš ï¸ " + (e && e.message ? e.message : "Error cargando tarifa.json");
        errEl.style.display = "block";
      }
    }

    // ----- Render -----
    function render(){
      const term = (q.value || "").trim().toLowerCase();
      const list = term
        ? productos.filter(p =>
            p.ref.toLowerCase().includes(term) ||
            p.name.toLowerCase().includes(term)
          )
        : productos;

      grid.innerHTML = "";
      for(const p of list){
        grid.appendChild(cardFor(p));
      }
      refreshTotals();
    }

    function cardFor(p){
      const fam = familyFromRef(p.ref);
      const sizes = sizesForFamily(fam);

      const card = document.createElement("div");
      card.className = "card";

      // top
      const top = document.createElement("div");
      top.className = "cardTop";

      const thumb = document.createElement("div");
      thumb.className = "thumb";

      const img = document.createElement("img");
      // Intento 1: images/<ref>.jpg
      img.src = `images/${p.ref}.jpg`;
      img.alt = p.ref;

      let triedSecond = false;
      img.onerror = () => {
        if (!triedSecond){
          triedSecond = true;
          // Intento 2: <ref>.jpg en raÃ­z (como tu 1299426.jpg)
          img.src = `${p.ref}.jpg`;
          return;
        }
        // Placeholder
        thumb.innerHTML = `<div class="ph">${p.ref}</div>`;
      };

      thumb.appendChild(img);

      const info = document.createElement("div");
      info.className = "info";

      const row1 = document.createElement("div");
      row1.className = "row1";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const ref = document.createElement("div");
      ref.className = "ref";
      ref.textContent = p.ref;

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.name || "â€”";

      left.appendChild(ref);
      left.appendChild(name);

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = (Number(p.price)||0).toFixed(2).replace(".", ",") + " â‚¬";

      row1.appendChild(left);
      row1.appendChild(price);

      info.appendChild(row1);

      top.appendChild(thumb);
      top.appendChild(info);

      // sizes area
      const sizesBox = document.createElement("div");
      sizesBox.className = "sizes";

      const sh = document.createElement("div");
      sh.className = "sizesHeader";
      sh.innerHTML = `<span>Familia: <strong>${fam || "â€”"}</strong></span><span>Tallas: <strong>${sizes.length}</strong></span>`;

      const sg = document.createElement("div");
      sg.className = "sizesGrid";

      sizes.forEach(size => {
        const line = document.createElement("div");
        line.className = "sizeLine";

        const tag = document.createElement("div");
        tag.className = "sizeTag";
        tag.textContent = size;

        const stepper = document.createElement("div");
        stepper.className = "stepper";

        const minus = document.createElement("button");
        minus.type = "button";
        minus.className = "btn";
        minus.textContent = "âˆ’";

        const input = document.createElement("input");
        input.className = "qty";
        input.type = "number";
        input.inputMode = "numeric";
        input.min = "0";
        input.step = "1";
        input.value = String(getQty(p.ref, size));

        const plus = document.createElement("button");
        plus.type = "button";
        plus.className = "btn";
        plus.textContent = "+";

        minus.addEventListener("click", () => {
          const v = Math.max(0, (Number(input.value)||0) - 1);
          input.value = String(v);
          setQty(p.ref, size, v);
          refreshLineTotal(card, p);
        });

        plus.addEventListener("click", () => {
          const v = (Number(input.value)||0) + 1;
          input.value = String(v);
          setQty(p.ref, size, v);
          refreshLineTotal(card, p);
        });

        input.addEventListener("change", () => {
          const v = Math.max(0, Number(input.value)||0);
          input.value = String(v);
          setQty(p.ref, size, v);
          refreshLineTotal(card, p);
        });

        stepper.appendChild(minus);
        stepper.appendChild(input);
        stepper.appendChild(plus);

        line.appendChild(tag);
        line.appendChild(stepper);

        sg.appendChild(line);
      });

      const lt = document.createElement("div");
      lt.className = "lineTotal";
      lt.innerHTML = `<span>Subtotal lÃ­nea</span><strong data-subtotal>0,00 â‚¬ Â· 0 uds</strong>`;

      sizesBox.appendChild(sh);
      sizesBox.appendChild(sg);
      sizesBox.appendChild(lt);

      card.appendChild(top);
      card.appendChild(sizesBox);

      // Calcula subtotal inicial
      refreshLineTotal(card, p);

      return card;
    }

    function refreshLineTotal(card, p){
      const ref = p.ref;
      const fam = familyFromRef(ref);
      const sizes = sizesForFamily(fam);

      let units = 0;
      for(const s of sizes) units += getQty(ref, s);

      const subtotal = units * (Number(p.price)||0);

      const el = card.querySelector("[data-subtotal]");
      if (el){
        el.textContent = `${formatEUR(subtotal)} â‚¬ Â· ${units} uds`;
      }
    }

    function refreshTotals(){
      let units = 0;
      let total = 0;
      let linesWithQty = 0;

      // Creamos un mapa de precios por ref para total rÃ¡pido
      const priceByRef = new Map(productos.map(p => [p.ref, Number(p.price)||0]));

      for(const ref of Object.keys(order)){
        let refUnits = 0;
        for(const s of Object.keys(order[ref])){
          const q = Number(order[ref][s])||0;
          refUnits += q;
          units += q;
        }
        if (refUnits > 0) linesWithQty += 1;
        total += refUnits * (priceByRef.get(ref) || 0);
      }

      document.getElementById("u").textContent = units;
      document.getElementById("t").textContent = formatEUR(total);
      linesEl.textContent = linesWithQty;
    }

    // ----- Resumen pedido -----
    const mb = document.getElementById("mb");
    const resume = document.getElementById("resume");

    function buildResume(){
      const priceByRef = new Map(productos.map(p => [p.ref, p]));
      const refs = Object.keys(order).sort();

      let out = [];
      out.push("ABUELA TATA Â· INVIERNO AW 26/27");
      out.push("RESUMEN DE PEDIDO");
      out.push("â€”");

      let totalUnits = 0;
      let totalEUR = 0;

      for(const ref of refs){
        const prod = priceByRef.get(ref);
        const name = prod ? prod.name : "";
        const price = prod ? (Number(prod.price)||0) : 0;

        const fam = familyFromRef(ref);
        const sizes = sizesForFamily(fam);

        let lineUnits = 0;
        let parts = [];

        for(const s of sizes){
          const q = getQty(ref, s);
          if (q > 0){
            parts.push(`${s}:${q}`);
            lineUnits += q;
          }
        }

        if (lineUnits === 0) continue;

        const lineEUR = lineUnits * price;
        totalUnits += lineUnits;
        totalEUR += lineEUR;

        out.push(`${ref} â€” ${name}`);
        out.push(`  ${parts.join("  ")}`);
        out.push(`  Precio: ${formatEUR(price)} â‚¬  Â· Subtotal: ${formatEUR(lineEUR)} â‚¬  Â· Uds: ${lineUnits}`);
        out.push("");
      }

      out.push("â€”");
      out.push(`TOTAL UNIDADES: ${totalUnits}`);
      out.push(`TOTAL â‚¬: ${formatEUR(totalEUR)} â‚¬`);

      return out.join("\n");
    }

    document.getElementById("btnResume").addEventListener("click", () => {
      resume.value = buildResume();
      mb.style.display = "flex";
    });

    document.getElementById("btnClose").addEventListener("click", () => mb.style.display = "none");
    document.getElementById("btnClose2").addEventListener("click", () => mb.style.display = "none");

    document.getElementById("btnCopy").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(resume.value);
        // mini feedback
        const old = document.getElementById("btnCopy").textContent;
        document.getElementById("btnCopy").textContent = "Copiado âœ…";
        setTimeout(()=>document.getElementById("btnCopy").textContent = old, 900);
      }catch(e){
        // si el navegador no deja, al menos seleccionamos
        resume.focus();
        resume.select();
      }
    });

    // Vaciar
    document.getElementById("btnClear").addEventListener("click", () => {
      // limpia estado
      for (const k of Object.keys(order)) delete order[k];
      // re-render para resetear inputs y subtotales
      render();
    });

    // Search
    q.addEventListener("input", () => render());

    // Arranque
    loadTarifa();
  </script>
</body>
</html>
