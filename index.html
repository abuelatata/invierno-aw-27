<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pedidos Invierno AW26/27 ‚Äî Abuela Tata</title>
<style>
:root{
  --bg:#f5f2ee;--card:#ffffff;--line:#e8e2db;--ink:#1f1f1f;--muted:#777;
  --accent:#1f1f1f;--radius:18px;--shadow:0 12px 34px rgba(0,0,0,.06);
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,var(--bg),#fff);color:var(--ink);}
.wrap{max-width:1180px;margin:0 auto;padding:22px}
.brand{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px}
.brand h1{margin:0;font-size:28px;letter-spacing:.3px}
.brand .sub{margin:0;color:var(--muted);font-size:13px}
.logoRow{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:12px;border:1px solid var(--line);background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
.logo img{width:100%;height:100%;object-fit:contain;display:block}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);
  background:rgba(255,255,255,.85);font-size:12px;color:var(--muted)}

.section{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow)}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media(max-width:980px){.grid3{grid-template-columns:1fr 1fr}}
@media(max-width:820px){.grid3{grid-template-columns:1fr}}

label{display:block;font-size:12px;color:var(--muted);margin:6px 0 6px}
input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;outline:none}
textarea{min-height:90px;resize:vertical}
.small{font-size:12px;color:var(--muted)}
.hint{font-size:12px;color:var(--muted);margin-top:8px}

.addbar{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.addbar input{flex:1;min-width:240px}

.products{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px}
@media(max-width:1000px){.products{grid-template-columns:repeat(2,1fr)}}
@media(max-width:650px){.products{grid-template-columns:1fr}}

.card{border:1px solid var(--line);border-radius:18px;overflow:hidden;background:#fff}
.cardTop{position:relative;background:#faf7f3;aspect-ratio:4/5}
.cardTop img{width:100%;height:100%;object-fit:cover;display:block;cursor:pointer;transition:transform .25s ease}
.cardTop img:hover{transform:scale(1.02)}
.badge{position:absolute;left:12px;top:12px;background:rgba(255,255,255,.92);border:1px solid var(--line);
  padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px}
.cardBody{padding:12px}
.meta{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
.meta .title{font-weight:900}
.priceRow{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:10px}
.priceRow .p{font-weight:900}
.priceRow .subt{font-weight:900}

.sizes{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
@media(min-width:520px){.sizes{grid-template-columns:repeat(3,1fr)}}
.sizeBox{border:1px solid var(--line);border-radius:12px;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.sizeBox .s{font-weight:900;font-size:12px}
.stepper{display:flex;align-items:center;gap:6px}
.stepper button{width:30px;height:30px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#222;font-weight:900;cursor:pointer}
.stepper button:hover{background:#f7f5f2}
.stepper input{width:44px;text-align:center;padding:6px 8px;border-radius:10px;margin:0;border:1px solid var(--line)}

.tableWrap{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 8px;border-bottom:1px solid #f0ede8;vertical-align:top}
th{font-size:12px;color:var(--muted);text-align:left}
td.right{text-align:right}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
.modal.open{display:flex}
.modalInner{max-width:920px;width:100%;background:#fff;border-radius:18px;overflow:hidden}
.modalInner img{width:100%;height:auto;display:block}
.modalClose{position:fixed;top:16px;right:16px;background:#fff;border:1px solid var(--line);border-radius:999px;
  padding:10px 12px;cursor:pointer;font-weight:900}

.actions{display:flex;flex-wrap:wrap;gap:10px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:11px 14px;border-radius:14px;border:1px solid var(--accent);
  background:var(--accent);color:#fff;cursor:pointer;font-weight:900;letter-spacing:.2px;box-shadow:0 10px 20px rgba(0,0,0,.12);
  transition:transform .12s ease, box-shadow .12s ease, background .12s ease}
.btn:hover{transform:translateY(-1px);box-shadow:0 14px 26px rgba(0,0,0,.14)}
.btn:active{transform:translateY(0px);box-shadow:0 10px 20px rgba(0,0,0,.12)}
.btn.secondary{background:#fff;color:var(--accent);box-shadow:none}
.btn.secondary:hover{background:#f7f5f2;box-shadow:none}
.btn .ic{font-size:16px;line-height:0}

.stickyBar{position:sticky;bottom:10px;z-index:50}
.stickyInner{border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.92);padding:10px;display:flex;gap:10px;
  justify-content:space-between;align-items:center;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.stickyInner .left{display:flex;gap:10px;align-items:center}
.stickyInner .tot{font-weight:900}
@media(max-width:720px){
  .stickyInner{border-radius:18px;flex-direction:column;align-items:stretch}
  .stickyInner .left{justify-content:space-between}
  .stickyInner .actions{justify-content:stretch}
  .stickyInner .actions .btn{flex:1}
}
</style>
</head>

<body>
<div class="wrap">

  <div class="brand">
    <div class="logoRow">
      <div class="logo" title="Logo">
        <img src="images/logo.png" alt="Abuela Tata" onerror="this.style.display='none'">
      </div>
      <div>
        <h1>ABUELA TATA</h1>
        <p class="sub">Pedidos Invierno AW26/27</p>
      </div>
    </div>
    <div class="pill" id="todayPill"></div>
  </div>

  <div class="section">
    <h3 style="margin:0 0 10px 0">Datos del cliente</h3>
    <div class="grid3">
      <div><label>Nombre fiscal</label><input id="fiscalName" placeholder="Nombre fiscal" /></div>
      <div><label>NIF / CIF</label><input id="taxId" placeholder="NIF / CIF" /></div>
      <div><label>Nombre tienda</label><input id="shopName" placeholder="Nombre tienda" /></div>

      <div><label>Persona de contacto</label><input id="contactPerson" placeholder="Persona de contacto" /></div>
      <div><label>Email (obligatorio)</label><input id="email" placeholder="Email" /></div>
      <div><label>Tel√©fono</label><input id="phone" placeholder="Tel√©fono" /></div>

      <div><label>Direcci√≥n</label><input id="address" placeholder="Direcci√≥n" /></div>
      <div><label>CP</label><input id="zip" placeholder="C√≥digo Postal" /></div>
      <div><label>Ciudad</label><input id="city" placeholder="Ciudad" /></div>

      <div><label>Provincia</label><input id="province" placeholder="Provincia" /></div>
    </div>

    <label>Notas</label>
    <textarea id="notes" placeholder="Notas"></textarea>
  </div>

  <div class="section">
    <h3 style="margin:0 0 10px 0">A√±adir referencia</h3>
    <div class="addbar">
      <div style="flex:1">
        <label>Referencia</label>
        <input id="refInput" placeholder="Escribe la referencia y pulsa Enter (ej: 1299426)" />
      </div>
      <button class="btn secondary" type="button" id="btnAdd"><span class="ic">‚ûï</span>A√±adir</button>
    </div>
    <div class="hint">Fotos: <b>images/REFERENCIA.jpg</b> (si no existe, se muestra <b>images/placeholder.jpg</b>). Pulsa la foto para ampliar.</div>
    <div class="products" id="products"></div>
  </div>

  <div class="section" id="summarySection">
    <h3 style="margin:0 0 10px 0">Resumen del pedido</h3>
    <div id="summaryTotals" class="small" style="margin-bottom:10px;"></div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Referencia</th>
            <th>Modelo</th>
            <th>Tallas</th>
            <th class="right">Uds</th>
            <th class="right">‚Ç¨/ud</th>
            <th class="right">Subtotal</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>
  </div>

  <div class="stickyBar">
    <div class="stickyInner">
      <div class="left">
        <div class="tot" id="grandTotal">Total: 0 uds ¬∑ 0,00 ‚Ç¨</div>
        <div class="small" id="draftStatus"></div>
      </div>
      <div class="actions">
        <button class="btn" type="button" id="btnEmail"><span class="ic">‚úâÔ∏è</span>Enviar</button>
        <button class="btn secondary" type="button" id="btnPdf"><span class="ic">üßæ</span>PDF</button>
        <button class="btn secondary" type="button" id="btnSave"><span class="ic">üíæ</span>Guardar</button>
        <button class="btn secondary" type="button" id="btnLoad"><span class="ic">üìÇ</span>Cargar</button>
        <button class="btn secondary" type="button" id="btnClear"><span class="ic">üóëÔ∏è</span>Borrar</button>
      </div>
    </div>
  </div>

</div>

<div id="imgModal" class="modal" aria-hidden="true">
  <div class="modalClose" id="modalClose">X</div>
  <div class="modalInner">
    <img id="modalImg" src="" alt="Imagen modelo" />
  </div>
</div>

<script>
(() => {
  const ORDER_TO = "info@abuelatata.com";
  const STORAGE_KEY = "pedidoInvierno_AW26_27";
  const PLACEHOLDER = "images/placeholder.jpg";

  // --- TARIFA (desde tu Excel) ---
  const TARIFA = {"899426":{"desc":"DIADEMA","price":9.25},"1299426":{"desc":"JESUSITO CON CAPOTA","price":53.8},"1399426":{"desc":"JESUSITO SIN CAPOTA","price":49.95},"2599426":{"desc":"VESTIDO","price":50.65},"4399426":{"desc":"CONJUNTO DE NI√ëO","price":31.75},"899427":{"desc":"DIADEMA","price":9.25},"1299427":{"desc":"JESUSITO CON CAPOTA","price":40.65},"1399427":{"desc":"JESUSITO SIN CAPOTA","price":34.5},"2599427":{"desc":"VESTIDO","price":38.85},"4399427":{"desc":"CONJUNTO DE NI√ëO","price":33.35},"43099427":{"desc":"CONJUNTO DE NI√ëO","price":33.35},"899428":{"desc":"DIADEMA","price":9.25},"1199428":{"desc":"PELELE","price":20.25},"1299428":{"desc":"JESUSITO CON CAPOTA","price":53.35},"1399428":{"desc":"JESUSITO SIN CAPOTA","price":50.75},"2599428":{"desc":"VESTIDO","price":51.7},"1299429":{"desc":"JESUSITO CON CAPOTA","price":47.15},"1399429":{"desc":"JESUSITO SIN CAPOTA","price":44.85},"2599429":{"desc":"VESTIDO","price":51.7},"899430":{"desc":"DIADEMA","price":9.25},"1299430":{"desc":"JESUSITO CON CAPOTA","price":39.7},"1399430":{"desc":"JESUSITO SIN CAPOTA","price":36.95},"2599430":{"desc":"VESTIDO","price":38.5},"4399430":{"desc":"CONJUNTO DE NI√ëO","price":31.35},"899431":{"desc":"DIADEMA","price":9.25},"1299431":{"desc":"JESUSITO CON CAPOTA","price":40.45},"1399431":{"desc":"JESUSITO SIN CAPOTA","price":37.95},"2599431":{"desc":"VESTIDO","price":39.8},"3099431":{"desc":"CONJUNTO DE NI√ëO","price":24.65},"809432":{"desc":"DIADEMA","price":9.25},"1209432":{"desc":"JESUSITO CON CAPOTA","price":39.15},"1309432":{"desc":"JESUSITO SIN CAPOTA","price":36.95},"2509432":{"desc":"VESTIDO","price":38.95},"4309432":{"desc":"CONJUNTO DE NI√ëO","price":29.75},"899432":{"desc":"DIADEMA","price":9.25},"1299432":{"desc":"JESUSITO CON CAPOTA","price":41.95},"1399432":{"desc":"JESUSITO SIN CAPOTA","price":39.25},"2599432":{"desc":"VESTIDO","price":41.65},"4399432":{"desc":"CONJUNTO DE NI√ëO","price":30.75},"899433":{"desc":"DIADEMA","price":9.25},"1299433":{"desc":"JESUSITO CON CAPOTA","price":46.75},"1399433":{"desc":"JESUSITO SIN CAPOTA","price":45.25},"2599433":{"desc":"VESTIDO","price":49.25},"899434":{"desc":"DIADEMA","price":9.25},"1199434":{"desc":"PELELE","price":22.65},"1299434":{"desc":"JESUSITO CON CAPOTA","price":44.45},"1399434":{"desc":"JESUSITO SIN CAPOTA","price":39.15},"2599434":{"desc":"VESTIDO","price":37.7},"805435":{"desc":"DIADEMA","price":9.25},"1205435":{"desc":"JESUSITO CON CAPOTA","price":41.5},"1305435":{"desc":"JESUSITO SIN CAPOTA","price":39.35},"2505435":{"desc":"VESTIDO","price":43.1},"899435":{"desc":"DIADEMA","price":9.25},"1208435":{"desc":"JESUSITO CON CAPOTA","price":41.5},"1308435":{"desc":"JESUSITO SIN CAPOTA","price":39.35},"2508435":{"desc":"VESTIDO","price":43.1},"220257":{"desc":"ABRIGO ROJO","price":40.75},"220357":{"desc":"ABRIGO AZUL MARINO","price":40.75},"220657":{"desc":"ABRIGO CAMEL","price":40.75},"220158":{"desc":"ABRIGO ROSA","price":37.65},"220258":{"desc":"ABRIGO ROJO","price":37.65},"220358":{"desc":"ABRIGO AZUL MARINO","price":37.65},"220658":{"desc":"ABRIGO CAMEL","price":37.65},"220159":{"desc":"ABRIGO ROSA","price":39.35},"220259":{"desc":"ABRIGO ROJO","price":39.35},"220359":{"desc":"ABRIGO AZUL MARINO","price":39.35},"220659":{"desc":"ABRIGO CAMEL","price":39.35},"220160":{"desc":"ABRIGO ROSA","price":37.75},"220260":{"desc":"ABRIGO ROJO","price":37.75},"220360":{"desc":"ABRIGO AZUL MARINO","price":37.75},"220660":{"desc":"ABRIGO CAMEL","price":37.75}};

  // Tallas por prefijo
  const SIZE_MAP = {
    baby: ["3M","6M","9M","12M","18M","2A","3A","4A"],                 // 11,12,13
    kid:  ["12M","18M","2A","3A","4A","5A","6A","8A","10A","12A"],     // 22,25,43
    acc:  ["U"]                                                        // diademas y accesorios
  };

  const el = (id) => document.getElementById(id);

  function todayES(){ return new Date().toLocaleDateString("es-ES"); }
  el("todayPill").textContent = "Fecha del pedido: " + todayES();

  function euro(n){
    const v = Number(n||0);
    return v.toFixed(2).replace(".", ",") + " ‚Ç¨";
  }

  function getSizesByRef(ref){
    ref = (ref||"").trim();
    if(ref.startsWith("89")) return SIZE_MAP.acc;
    if(ref.startsWith("12") || ref.startsWith("13") || ref.startsWith("11")) return SIZE_MAP.baby;
    if(ref.startsWith("25") || ref.startsWith("43") || ref.startsWith("22")) return SIZE_MAP.kid;
    return SIZE_MAP.kid; // 24 u otros: de momento kid
  }

  function imagePathForRef(ref){ return `images/${ref}.jpg`; }

  function openImage(src){
    el("modalImg").src = src;
    el("imgModal").classList.add("open");
    el("imgModal").setAttribute("aria-hidden","false");
  }
  function closeImage(){
    el("imgModal").classList.remove("open");
    el("imgModal").setAttribute("aria-hidden","true");
  }
  el("modalClose").addEventListener("click", closeImage);
  el("imgModal").addEventListener("click", (e)=>{ if(e.target.id==="imgModal") closeImage(); });

  function addProduct(ref){
    ref = (ref||"").trim();
    if(!ref) return;

    if(!TARIFA[ref]){
      alert("Esa referencia no est√° en la tarifa: " + ref);
      return;
    }

    const exists = Array.from(document.querySelectorAll(".card")).some(c => c.dataset.ref === ref);
    if(exists) return;

    const item = TARIFA[ref];
    const price = Number(item.price||0);
    const desc = item.desc || "";

    const sizes = getSizesByRef(ref);
    const imgSrc = imagePathForRef(ref);

    const card = document.createElement("div");
    card.className = "card";
    card.dataset.ref = ref;

    card.innerHTML = `
      <div class="cardTop">
        <div class="badge">${ref}</div>
        <img src="${imgSrc}" alt="${ref}">
      </div>
      <div class="cardBody">
        <div class="meta">
          <div>
            <div class="title">${desc}</div>
            <div class="small">Ref: <b>${ref}</b></div>
          </div>
          <button class="btn secondary" type="button"><span class="ic">üóëÔ∏è</span>Quitar</button>
        </div>

        <div class="priceRow">
          <div class="small">Precio/ud: <span class="p">${euro(price)}</span></div>
          <div class="small">Subtotal: <span class="subt subtotal">0,00 ‚Ç¨</span></div>
        </div>

        <div class="sizes"></div>
      </div>
    `;

    const img = card.querySelector("img");
    img.addEventListener("click", ()=>openImage(img.src));
    img.addEventListener("error", ()=>{ img.src = PLACEHOLDER; });

    card.querySelector("button").addEventListener("click", ()=>{
      card.remove();
      recalcSummary();
      saveDraftSilent();
    });

    const sizesDiv = card.querySelector(".sizes");
    sizes.forEach(s => {
      const box = document.createElement("div");
      box.className = "sizeBox";
      box.innerHTML = `
        <div class="s">${s}</div>
        <div class="stepper">
          <button type="button" class="dec" aria-label="Disminuir">‚àí</button>
          <input type="number" min="0" value="0" data-size="${s}">
          <button type="button" class="inc" aria-label="Aumentar">+</button>
        </div>
      `;
      sizesDiv.appendChild(box);
    });

    card.querySelectorAll(".inc").forEach(btn => {
      btn.addEventListener("click", ()=>{
        const input = btn.parentElement.querySelector("input[data-size]");
        input.value = String(Number(input.value||"0") + 1);
        recalcSummary(); saveDraftSilent();
      });
    });
    card.querySelectorAll(".dec").forEach(btn => {
      btn.addEventListener("click", ()=>{
        const input = btn.parentElement.querySelector("input[data-size]");
        input.value = String(Math.max(0, Number(input.value||"0") - 1));
        recalcSummary(); saveDraftSilent();
      });
    });
    card.querySelectorAll("input[data-size]").forEach(inp => {
      inp.addEventListener("input", ()=>{
        if(Number(inp.value) < 0) inp.value = "0";
        recalcSummary(); saveDraftSilent();
      });
    });

    el("products").appendChild(card);
    recalcSummary();
    saveDraftSilent();
  }

  function hasAnyQty(){
    return Array.from(document.querySelectorAll(".card input[data-size]"))
      .some(inp => Number(inp.value||"0") > 0);
  }

  function recalcSummary(){
    const rows = [];
    let grandUnits = 0;
    let grandEuros = 0;

    document.querySelectorAll(".card").forEach(card => {
      const ref = card.dataset.ref || "";
      const item = TARIFA[ref] || {};
      const desc = item.desc || "";
      const price = Number(item.price||0);

      let units = 0;
      const qtyBySize = {};

      card.querySelectorAll("input[data-size]").forEach(inp => {
        const size = inp.dataset.size;
        const qty = Number(inp.value || "0");
        if(qty > 0){
          qtyBySize[size] = qty;
          units += qty;
        }
      });

      const subtotal = units * price;

      const subEl = card.querySelector(".subtotal");
      if(subEl) subEl.textContent = euro(subtotal);

      if(units > 0){
        grandUnits += units;
        grandEuros += subtotal;
        const sizesText = Object.entries(qtyBySize).map(([s,q]) => `${s}:${q}`).join(" ¬∑ ");
        rows.push({ref, desc, sizesText, units, price, subtotal});
      }
    });

    const body = el("summaryBody");
    const totals = el("summaryTotals");

    body.innerHTML = rows.length ? rows.map(r => `
      <tr>
        <td style="font-weight:900">${r.ref}</td>
        <td>${r.desc}</td>
        <td>${r.sizesText}</td>
        <td class="right" style="font-weight:900">${r.units}</td>
        <td class="right">${euro(r.price)}</td>
        <td class="right" style="font-weight:900">${euro(r.subtotal)}</td>
      </tr>
    `).join("") : `<tr><td colspan="6" class="small" style="padding:12px">A√∫n no hay cantidades.</td></tr>`;

    totals.textContent = `L√≠neas con cantidades: ${rows.length}`;
    el("grandTotal").textContent = `Total: ${grandUnits} uds ¬∑ ${euro(grandEuros)}`;
  }

  function buildOrderText(){
    const client = {
      fiscalName: el("fiscalName").value.trim(),
      taxId: el("taxId").value.trim(),
      shopName: el("shopName").value.trim(),
      contactPerson: el("contactPerson").value.trim(),
      email: el("email").value.trim(),
      phone: el("phone").value.trim(),
      address: el("address").value.trim(),
      zip: el("zip").value.trim(),
      city: el("city").value.trim(),
      province: el("province").value.trim(),
      notes: el("notes").value.trim(),
    };

    let grandUnits = 0;
    let grandEuros = 0;

    let lines = [];
    document.querySelectorAll(".card").forEach(c => {
      const ref = c.dataset.ref;
      const item = TARIFA[ref] || {};
      const desc = item.desc || "";
      const price = Number(item.price||0);

      c.querySelectorAll("input[data-size]").forEach(inp => {
        const qty = Number(inp.value || "0");
        if(qty > 0){
          const subtotal = qty * price;
          grandUnits += qty;
          grandEuros += subtotal;
          lines.push(`${ref} ‚Äî ${desc} ‚Äî ${inp.dataset.size}: ${qty}  |  ${euro(price)}  =>  ${euro(subtotal)}`);
        }
      });
    });

    return `PEDIDO INVIERNO AW26/27 ‚Äî ABUELA TATA
Fecha: ${todayES()}

DATOS CLIENTE
Nombre fiscal: ${client.fiscalName}
NIF/CIF: ${client.taxId}
Nombre tienda: ${client.shopName}
Persona contacto: ${client.contactPerson}
Email: ${client.email}
Tel√©fono: ${client.phone}
Direcci√≥n: ${client.address}
CP / Ciudad: ${client.zip} ${client.city}
Provincia: ${client.province}

PEDIDO:
${lines.length ? lines.join("\n") : "(Sin l√≠neas de pedido. A√±ade cantidades.)"}

TOTAL:
${grandUnits} uds ¬∑ ${euro(grandEuros)}

Notas:
${client.notes || "-"}

All the best,
Abuela Tata
`;
  }

  function sendByEmail(){
    const clientEmail = el("email").value.trim();
    if(!clientEmail){ alert("Email obligatorio."); return; }
    if(!hasAnyQty()){ alert("No hay cantidades en el pedido."); return; }

    const shop = el("shopName").value.trim() || el("fiscalName").value.trim() || "Cliente";
    const subject = `Pedido Invierno AW26/27 ‚Äî ${shop} ‚Äî ${todayES()}`;
    const body = buildOrderText();

    const mailto =
      `mailto:${encodeURIComponent(ORDER_TO)}` +
      `?cc=${encodeURIComponent(clientEmail)}` +
      `&subject=${encodeURIComponent(subject)}` +
      `&body=${encodeURIComponent(body)}`;

    window.location.href = mailto;
  }

  function saveAsPDF(){
    const win = window.open("", "_blank");
    const text = buildOrderText()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    win.document.write(`
      <html><head><title>Pedido Abuela Tata</title>
      <style>
        body{font-family:Arial;padding:28px}
        h1{margin:0 0 6px 0}
        pre{white-space:pre-wrap;font-size:12px;line-height:1.35}
      </style>
      </head><body>
        <h1>ABUELA TATA</h1>
        <pre>${text}</pre>
        <script>window.print();<\/script>
      </body></html>
    `);
    win.document.close();
  }

  function buildDraftPayload(){
    return {
      client: {
        fiscalName: el("fiscalName").value,
        taxId: el("taxId").value,
        shopName: el("shopName").value,
        contactPerson: el("contactPerson").value,
        email: el("email").value,
        phone: el("phone").value,
        address: el("address").value,
        zip: el("zip").value,
        city: el("city").value,
        province: el("province").value,
        notes: el("notes").value
      },
      products: Array.from(document.querySelectorAll(".card")).map(c => ({
        ref: c.dataset.ref,
        qty: Array.from(c.querySelectorAll("input[data-size]")).reduce((acc,inp)=>{
          acc[inp.dataset.size] = Number(inp.value||"0");
          return acc;
        },{})
      }))
    };
  }

  function saveDraftSilent(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(buildDraftPayload()));
      el("draftStatus").textContent = "Borrador guardado";
    }catch(e){}
  }
  function saveDraft(){ saveDraftSilent(); alert("Borrador guardado ‚úÖ"); }

  function loadDraft(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ alert("No hay borrador guardado."); return; }
    const data = JSON.parse(raw);

    if(data.client){
      el("fiscalName").value = data.client.fiscalName || "";
      el("taxId").value = data.client.taxId || "";
      el("shopName").value = data.client.shopName || "";
      el("contactPerson").value = data.client.contactPerson || "";
      el("email").value = data.client.email || "";
      el("phone").value = data.client.phone || "";
      el("address").value = data.client.address || "";
      el("zip").value = data.client.zip || "";
      el("city").value = data.client.city || "";
      el("province").value = data.client.province || "";
      el("notes").value = data.client.notes || "";
    }

    el("products").innerHTML = "";
    (data.products || []).forEach(p => {
      if(!p.ref) return;
      addProduct(p.ref);
      const card = Array.from(document.querySelectorAll(".card")).find(x => x.dataset.ref === p.ref);
      if(card && p.qty){
        card.querySelectorAll("input[data-size]").forEach(inp => {
          const v = p.qty[inp.dataset.size];
          if(v != null) inp.value = String(v);
        });
      }
    });

    recalcSummary();
    el("draftStatus").textContent = "Borrador cargado";
    alert("Borrador cargado ‚úÖ");
  }

  function clearAll(){
    if(!confirm("¬øBorrar todo el pedido?")) return;
    ["fiscalName","taxId","shopName","contactPerson","email","phone","address","zip","city","province","notes"].forEach(id => el(id).value = "");
    el("products").innerHTML = "";
    localStorage.removeItem(STORAGE_KEY);
    recalcSummary();
    el("draftStatus").textContent = "";
  }

  function addFromInput(){
    const ref = el("refInput").value.trim();
    addProduct(ref);
    el("refInput").value = "";
  }
  el("btnAdd").addEventListener("click", addFromInput);
  el("refInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addFromInput(); } });

  ["fiscalName","taxId","shopName","contactPerson","email","phone","address","zip","city","province","notes"].forEach(id=>{
    el(id).addEventListener("input", saveDraftSilent);
  });

  el("btnEmail").addEventListener("click", sendByEmail);
  el("btnPdf").addEventListener("click", saveAsPDF);
  el("btnSave").addEventListener("click", saveDraft);
  el("btnLoad").addEventListener("click", loadDraft);
  el("btnClear").addEventListener("click", clearAll);

  recalcSummary();
})();
</script>
</body>
</html>
