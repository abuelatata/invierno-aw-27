<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Abuela Tata · Invierno AW 26/27 · Pedidos</title>

  <!-- jsPDF (PDF). Si no carga, la app sigue funcionando. -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#fbfaf8;
      --card:#ffffff;
      --ink:#121212;
      --muted:rgba(18,18,18,.62);
      --line:rgba(0,0,0,.10);
      --shadow:0 18px 44px rgba(0,0,0,.09);
      --r:18px;
      --r2:14px;
      --pad:14px;
      --good:#0b7a2a;
      --bad:#b00020;
      --primary:#111;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--ink);
    }

    /* Anti-blank fallback */
    .fatal{
      position:fixed; inset:0;
      display:none;
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      backdrop-filter: blur(10px);
      z-index:9999;
      overflow:auto;
    }
    .fatal__box{
      max-width: 860px;
      margin: 0 auto;
      background:#fff;
      border:1px solid rgba(176,0,32,.18);
      border-radius:18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.12);
      padding: 14px;
    }
    .fatal h1{margin:0 0 8px;font-size:1.1rem}
    .fatal p{margin:6px 0;color:rgba(0,0,0,.75);line-height:1.4}
    .fatal pre{
      margin:10px 0 0;
      padding:10px;
      background:#fafafa;
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      font-size:.92rem;
    }

    .wrap{max-width:1120px;margin:0 auto;padding:14px 14px 120px}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:8px 2px 14px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0}
    .logo{
      width:46px;height:46px;border-radius:14px;background:#fff;
      border:1px solid var(--line); display:grid; place-items:center;
      overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:contain}
    .ttl{min-width:0}
    .ttl h1{margin:0;font-size:1.02rem;letter-spacing:.2px}
    .ttl p{margin:2px 0 0;color:var(--muted);font-size:.90rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .grid{display:grid; grid-template-columns: 1.3fr .7fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, #fff, rgba(255,255,255,.86));
    }
    .card .hd h2{margin:0;font-size:1.02rem}
    .card .bd{padding:14px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{color:var(--muted);font-size:.92rem;line-height:1.35;margin:8px 0 0}

    /* Buttons (más bonitos) */
    .btn{
      border:1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg,#ffffff,#f6f6f6);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .btn:hover{ box-shadow: 0 14px 22px rgba(0,0,0,.08); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg,#1a1a1a,#0c0c0c);
      color:#fff;
      border-color:#0c0c0c;
    }
    .btn.danger{
      background: linear-gradient(180deg,#fff,#fff);
      color:var(--bad);
      border-color: rgba(176,0,32,.22);
    }
    .btn.small{padding:8px 10px;border-radius:12px}
    .btn.btn--icon{
      padding: 10px;
      width: 42px;
      height: 42px;
      justify-content:center;
      border-radius: 14px;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:999px;padding:6px 10px;background:#fff;font-weight:800;
    }
    .money{font-weight:900}
    .muted{color:var(--muted)}

    /* Line item */
    .line{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin-bottom:12px;
      background:rgba(255,255,255,.92);
    }
    .lineTop{display:flex;gap:12px;align-items:flex-start}

    /* Clickable image */
    .pimgBtn{
      width:76px;height:76px;border-radius:16px;border:1px solid var(--line);
      background:#fff;overflow:hidden;flex:0 0 auto;
      padding:0; cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .pimgBtn img{width:100%;height:100%;object-fit:cover;display:block}

    .meta{flex:1;min-width:0}
    .meta .r1{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .meta .r2{margin-top:6px;color:var(--muted);font-size:.92rem;line-height:1.25}
    .meta .r2 b{color:var(--ink)}

    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 220px; flex:1;
    }
    label{font-size:.84rem;color:var(--muted);font-weight:700}
    input, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-size:1rem;
    }
    textarea{min-height:160px;resize:vertical}

    /* Sizes */
    .sizes{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .sz{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
    }
    .sz .t{font-weight:900;font-size:.9rem}
    .step{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
    }
    .step button{
      width:30px;height:28px;border:0;background:transparent;cursor:pointer;font-weight:900;
    }
    .step input{
      width:44px;border:0;border-left:1px solid rgba(0,0,0,.10);border-right:1px solid rgba(0,0,0,.10);
      border-radius:0;padding:0;text-align:center;font-weight:900;
    }

    /* Autocomplete */
    .suggest-wrap{position:relative;flex:1;min-width:220px}
    .suggest{
      position:absolute;left:0;right:0;top:64px;
      z-index:9999;background:rgba(255,255,255,.98);
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      box-shadow:0 14px 30px rgba(0,0,0,.12);
      overflow:hidden;
      max-height:280px;overflow-y:auto;
      display:none;
    }
    .suggest-item{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding:10px 12px;cursor:pointer;border-bottom:1px solid rgba(0,0,0,.06);
    }
    .suggest-item:last-child{border-bottom:0}
    .suggest-item:hover,.suggest-item.active{background:rgba(0,0,0,.05)}
    .suggest-item .ref{font-weight:900}
    .suggest-item .desc{font-size:.92rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:62vw}
    .suggest-item .price{font-weight:900;white-space:nowrap}

    /* Summary table */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{
      font-size:.82rem;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);
      text-align:left;padding:0 8px
    }
    td{
      background:#fff;border:1px solid var(--line);
      padding:10px 8px;vertical-align:top
    }
    td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
    td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
    .nowrap{white-space:nowrap}
    .right{text-align:right}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:4px 8px;font-weight:800;background:#fff;font-size:.86rem}

    /* Bottom bar */
    .bar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      z-index:1000;
    }
    .barin{
      max-width:1120px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .totals{display:flex;gap:10px;flex-wrap:wrap}

    /* Lightbox */
    .modal{ position:fixed; inset:0; display:none; z-index:2000; }
    .modal[aria-hidden="false"]{ display:block; }
    .modal__backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }
    .modal__panel{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:min(720px, calc(100vw - 24px));
      background:#fff;
      border:1px solid rgba(0,0,0,.12);
      border-radius: 20px;
      box-shadow: 0 28px 60px rgba(0,0,0,.20);
      overflow:hidden;
    }
    .modal__close{
      position:absolute; top:10px; right:10px;
      z-index:2;
    }
    .modal__content{ padding: 14px; }
    .modal__content img{
      width:100%;
      height:auto;
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
    }
    .modal__cap{ margin-top:10px; }
    .modal__ref{ font-weight: 900; font-size: 1rem; }
    .modal__desc{ color: rgba(0,0,0,.65); margin-top:2px; }

    /* Small */
    @media (max-width: 420px){
      .field{min-width: 100%}
    }
  </style>
</head>

<body>
  <!-- Pantalla de aviso si algo falla (evita “todo blanco”) -->
  <div class="fatal" id="fatal">
    <div class="fatal__box">
      <h1>Se ha detectado un problema al cargar la aplicación</h1>
      <p>No te preocupes: esto suele ser un detalle de publicación o una librería que no ha cargado. Abajo tienes el mensaje para que lo pueda corregir al instante.</p>
      <pre id="fatalMsg"></pre>
      <p style="margin-top:10px"><b>Consejo rápido:</b> abre la web con <code>?v=999</code> al final para evitar caché.</p>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">
          <img src="images/logo.png" alt="Abuela Tata"
               onerror="this.style.display='none';this.parentElement.textContent='AT';this.parentElement.style.fontWeight='900';" />
        </div>
        <div class="ttl">
          <h1>Pedidos · Invierno AW 26/27</h1>
          <p>Referencias · tallas · totales · email y PDF</p>
        </div>
      </div>

      <button class="btn primary" id="addLineBtn" type="button">Añadir referencia</button>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Pedido</h2>
          <div class="row">
            <span class="pill"><span class="muted">Unidades:</span> <span id="totalUds" class="money">0</span></span>
            <span class="pill"><span class="muted">Total:</span> <span id="totalEur" class="money">0,00 €</span></span>
          </div>
        </div>
        <div class="bd">
          <p class="hint">
            Escribe “12” y verás el desplegable con las referencias <b>12xxxx</b> (precio y descripción).
            Toca la imagen para verla ampliada.
          </p>

          <div id="lines"></div>

          <div class="row">
            <button class="btn" id="addLineBtn2" type="button">Añadir otra referencia</button>
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="hd">
          <h2>Resumen · Email · PDF</h2>
          <div class="row">
            <button class="btn" id="copyEmailBtn" type="button">Copiar email</button>
            <button class="btn" id="mailtoBtn" type="button">Abrir email</button>
            <button class="btn primary" id="pdfBtn" type="button">Generar PDF</button>
          </div>
        </div>
        <div class="bd">
          <div id="summaryWrap"></div>

          <div style="height:12px"></div>

          <label for="emailBox">Email (bien estructurado)</label>
          <textarea id="emailBox" spellcheck="false"></textarea>

          <p class="hint">
            Si al pulsar “Generar PDF” la librería tarda en cargar, recarga con <b>Ctrl+F5</b> y vuelve a intentarlo.
            El email siempre funciona.
          </p>
        </div>
      </aside>
    </div>
  </div>

  <div class="bar">
    <div class="barin">
      <div class="totals">
        <span class="pill"><span class="muted">Unidades:</span> <span id="totalUds2" class="money">0</span></span>
        <span class="pill"><span class="muted">Total:</span> <span id="totalEur2" class="money">0,00 €</span></span>
      </div>
      <div class="row">
        <button class="btn danger" id="clearBtn" type="button">Vaciar pedido</button>
        <button class="btn primary" id="pdfBtn2" type="button">PDF</button>
      </div>
    </div>
  </div>

  <!-- Visor de imagen (Lightbox) -->
  <div id="imgModal" class="modal" aria-hidden="true">
    <div class="modal__backdrop" data-close="1"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-label="Imagen de producto">
      <button class="btn btn--icon modal__close" data-close="1" title="Cerrar" type="button">✕</button>
      <div class="modal__content">
        <img id="imgModalPic" alt="Imagen ampliada" />
        <div class="modal__cap">
          <div id="imgModalRef" class="modal__ref"></div>
          <div id="imgModalDesc" class="modal__desc"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // =======================
    // TARIFA INCRUSTADA (AW 26/27)
    // =======================
    // Nota: puedes ampliar este mapa cuando quieras.
    window.PRICE_MAP = {
      "0899426":{"desc":"DIADEMA","price":9.25},
      "1299426":{"desc":"JESUSITO CON CAPOTA","price":53.80},
      "1399426":{"desc":"JESUSITO SIN CAPOTA","price":49.95},
      "2599426":{"desc":"VESTIDO","price":50.65},
      "4399426":{"desc":"CONJUNTO DE NIÑO","price":31.75},

      "0899427":{"desc":"DIADEMA","price":9.25},
      "1299427":{"desc":"JESUSITO CON CAPOTA","price":40.65},
      "1399427":{"desc":"JESUSITO SIN CAPOTA","price":34.50},
      "2599427":{"desc":"VESTIDO","price":38.85},
      "4399427":{"desc":"CONJUNTO DE NIÑO","price":33.35},
      "43099427":{"desc":"CONJUNTO DE NIÑO","price":33.35},

      "0899428":{"desc":"DIADEMA","price":9.25},
      "1199428":{"desc":"PELELE","price":20.25},
      "1299428":{"desc":"JESUSITO CON CAPOTA","price":53.35},
      "1399428":{"desc":"JESUSITO SIN CAPOTA","price":50.75},
      "2599428":{"desc":"VESTIDO","price":51.70},

      "1299429":{"desc":"JESUSITO CON CAPOTA","price":47.15},
      "1399429":{"desc":"JESUSITO SIN CAPOTA","price":44.85},
      "2599429":{"desc":"VESTIDO","price":51.70},

      "0899430":{"desc":"DIADEMA","price":9.25},
      "1299430":{"desc":"JESUSITO CON CAPOTA","price":39.70},
      "1399430":{"desc":"JESUSITO SIN CAPOTA","price":36.95},
      "2599430":{"desc":"VESTIDO","price":38.50},
      "4399430":{"desc":"CONJUNTO DE NIÑO","price":31.35},

      "0899431":{"desc":"DIADEMA","price":9.25},
      "1299431":{"desc":"JESUSITO CON CAPOTA","price":40.45},
      "1399431":{"desc":"JESUSITO SIN CAPOTA","price":37.95},
      "2599431":{"desc":"VESTIDO","price":39.80},
      "3099431":{"desc":"CONJUNTO DE NIÑO","price":24.65},

      "0809432":{"desc":"DIADEMA","price":9.25},
      "1209432":{"desc":"JESUSITO CON CAPOTA","price":39.15},
      "1309432":{"desc":"JESUSITO SIN CAPOTA","price":36.95},
      "2509432":{"desc":"VESTIDO","price":38.95},
      "4309432":{"desc":"CONJUNTO DE NIÑO","price":29.75},
      "0899432":{"desc":"DIADEMA","price":9.25},
      "1299432":{"desc":"JESUSITO CON CAPOTA","price":41.95},
      "1399432":{"desc":"JESUSITO SIN CAPOTA","price":39.25},
      "2599432":{"desc":"VESTIDO","price":41.65},
      "4399432":{"desc":"CONJUNTO DE NIÑO","price":30.75},

      "0899433":{"desc":"DIADEMA","price":9.25},
      "1299433":{"desc":"JESUSITO CON CAPOTA","price":41.95},
      "1399433":{"desc":"JESUSITO SIN CAPOTA","price":39.25},
      "2599433":{"desc":"VESTIDO","price":41.65},
      "4399433":{"desc":"CONJUNTO DE NIÑO","price":30.75},

      "0899434":{"desc":"DIADEMA","price":9.25},
      "1299434":{"desc":"JESUSITO CON CAPOTA","price":41.50},
      "1399434":{"desc":"JESUSITO SIN CAPOTA","price":39.35},
      "2599434":{"desc":"VESTIDO","price":43.10},

      "0899435":{"desc":"DIADEMA","price":9.25},
      "1208435":{"desc":"JESUSITO CON CAPOTA","price":41.50},
      "1308435":{"desc":"JESUSITO SIN CAPOTA","price":39.35},
      "2508435":{"desc":"VESTIDO","price":43.10},
      "2505435":{"desc":"VESTIDO","price":43.10},

      "220257":{"desc":"ABRIGO ROJO","price":40.75},
      "220357":{"desc":"ABRIGO AZUL MARINO","price":40.75},
      "220657":{"desc":"ABRIGO CAMEL","price":40.75},
      "220158":{"desc":"ABRIGO ROSA","price":37.65},
      "220258":{"desc":"ABRIGO ROJO","price":37.65},
      "220358":{"desc":"ABRIGO AZUL MARINO","price":37.65},
      "220658":{"desc":"ABRIGO CAMEL","price":37.65},
      "220159":{"desc":"ABRIGO ROSA","price":39.35},
      "220259":{"desc":"ABRIGO ROJO","price":39.35},
      "220359":{"desc":"ABRIGO AZUL MARINO","price":39.35},
      "220659":{"desc":"ABRIGO CAMEL","price":39.35},
      "220160":{"desc":"ABRIGO ROSA","price":37.75},
      "220260":{"desc":"ABRIGO ROJO","price":37.75},
      "220360":{"desc":"ABRIGO AZUL MARINO","price":37.75},
      "220660":{"desc":"ABRIGO CAMEL","price":37.75}
    };

    // =======================
    // APP
    // =======================
    const SIZES = ["3M","6M","9M","12M","18M","2Y","3Y","4Y","5Y","6Y","8Y","10Y","12Y"];
    const state = { lines: [] };

    const $ = (sel)=>document.querySelector(sel);

    function fatal(err){
      try{
        const el = $("#fatal");
        const msg = $("#fatalMsg");
        msg.textContent = String(err && (err.stack || err.message) ? (err.stack || err.message) : err);
        el.style.display = "block";
      }catch(e){}
    }

    function eur(n){
      const v = Number(n||0);
      try{
        return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v);
      }catch(e){
        return (Math.round(v*100)/100).toFixed(2).replace('.', ',') + " €";
      }
    }
    function n2(v){ return Math.max(0, Math.floor(Number(v||0))); }

    function defaultLine(){
      const qty = {};
      SIZES.forEach(s=>qty[s]=0);
      return { ref:"", desc:"", price:0, qty, id: (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())) };
    }

    function getInfoByRef(ref){
      const it = window.PRICE_MAP[String(ref||"").trim()];
      if(!it) return {desc:"", price:0};
      return {desc: it.desc || "", price: Number(it.price||0)};
    }

    function lineUnits(line){
      return SIZES.reduce((a,s)=>a + n2(line.qty[s]), 0);
    }
    function lineSubtotal(line){
      return lineUnits(line) * Number(line.price||0);
    }
    function totalUnits(){
      return state.lines.reduce((a,l)=>a+lineUnits(l),0);
    }
    function totalEur(){
      return state.lines.reduce((a,l)=>a+lineSubtotal(l),0);
    }

    function imgForRef(ref){
      const r = String(ref||"").trim();
      if(!r) return "images/placeholder.jpg";
      return `images/${r}.jpg`;
    }

    // ===== Lightbox =====
    function openImageModal({src, ref, desc}){
      const modal = document.getElementById("imgModal");
      const pic = document.getElementById("imgModalPic");
      const r = document.getElementById("imgModalRef");
      const d = document.getElementById("imgModalDesc");

      pic.src = src;
      r.textContent = ref ? `REF ${ref}` : "";
      d.textContent = desc || "";

      modal.setAttribute("aria-hidden","false");
    }
    function closeImageModal(){
      const modal = document.getElementById("imgModal");
      modal.setAttribute("aria-hidden","true");
      const pic = document.getElementById("imgModalPic");
      pic.src = "";
    }
    document.addEventListener("click", (e)=>{
      if(e.target && e.target.dataset && e.target.dataset.close === "1"){
        closeImageModal();
      }
    });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeImageModal();
    });

    // ===== Render =====
    function render(){
      const linesWrap = $("#lines");
      linesWrap.innerHTML = "";

      state.lines.forEach((line, idx)=>{
        const card = document.createElement("div");
        card.className = "line";
        card.innerHTML = `
          <div class="lineTop">
            <button class="pimgBtn" type="button" data-act="zoom" data-i="${idx}" title="Ver imagen ampliada">
              <img src="${imgForRef(line.ref)}" alt="" onerror="this.src='images/placeholder.jpg'">
            </button>

            <div class="meta">
              <div class="r1">
                <div class="field suggest-wrap">
                  <label>Referencia</label>
                  <input type="text" inputmode="numeric" placeholder="Ej.: 1299426"
                         value="${line.ref}" data-i="${idx}" class="refInput">
                  <div class="suggest" id="suggest_${line.id}"></div>
                </div>

                <div class="field">
                  <label>Descripción</label>
                  <input type="text" placeholder="(automática)"
                         value="${line.desc}" data-i="${idx}" class="descInput">
                </div>

                <div class="field" style="max-width:170px">
                  <label>Precio (€/ud)</label>
                  <input type="number" step="0.01" value="${Number(line.price||0)}"
                         data-i="${idx}" class="priceInput">
                </div>

                <button class="btn small danger" data-act="del" data-i="${idx}" type="button">Eliminar</button>
              </div>

              <div class="r2">
                <b>Subtotal:</b> <span class="money">${eur(lineSubtotal(line))}</span>
                <span class="muted"> · Unidades: ${lineUnits(line)}</span>
              </div>

              <div class="sizes">
                ${SIZES.map(s=>`
                  <div class="sz">
                    <span class="t">${s}</span>
                    <span class="step">
                      <button data-act="minus" data-i="${idx}" data-s="${s}" type="button" aria-label="Disminuir">−</button>
                      <input value="${n2(line.qty[s])}" inputmode="numeric" data-act="qty" data-i="${idx}" data-s="${s}">
                      <button data-act="plus" data-i="${idx}" data-s="${s}" type="button" aria-label="Aumentar">+</button>
                    </span>
                  </div>
                `).join("")}
              </div>
            </div>
          </div>
        `;

        linesWrap.appendChild(card);

        // Autocomplete por línea
        const refInp = card.querySelector(".refInput");
        const sugBox = card.querySelector(`#suggest_${line.id}`);
        setupAutocomplete(refInp, sugBox, idx);
      });

      $("#totalUds").textContent = totalUnits();
      $("#totalUds2").textContent = totalUnits();
      $("#totalEur").textContent = eur(totalEur());
      $("#totalEur2").textContent = eur(totalEur());

      renderSummary();
      renderEmail();
    }

    function renderSummary(){
      const wrap = $("#summaryWrap");
      const rows = state.lines
        .filter(l=>String(l.ref||"").trim() && lineUnits(l)>0)
        .map(l=>{
          const tallas = SIZES.filter(s=>n2(l.qty[s])>0).map(s=>({s, q:n2(l.qty[s])}));
          return { ref:l.ref, desc:l.desc, price:l.price, uds:lineUnits(l), sub:lineSubtotal(l), tallas };
        });

      if(!rows.length){
        wrap.innerHTML = `<p class="hint">Aún no hay líneas con unidades. Añade una referencia y asigna cantidades por talla.</p>`;
        return;
      }

      wrap.innerHTML = `
        <label>Resumen</label>
        <table>
          <thead>
            <tr>
              <th class="nowrap">Ref.</th>
              <th>Descripción</th>
              <th class="nowrap right">€/ud</th>
              <th>Tallas</th>
              <th class="nowrap right">Uds</th>
              <th class="nowrap right">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td class="nowrap"><b>${r.ref}</b></td>
                <td>${r.desc || '<span class="muted">(sin descripción)</span>'}</td>
                <td class="nowrap right">${eur(r.price)}</td>
                <td>
                  <div class="chips">
                    ${r.tallas.map(t=>`<span class="chip">${t.s}: ${t.q}</span>`).join("")}
                  </div>
                </td>
                <td class="nowrap right"><b>${r.uds}</b></td>
                <td class="nowrap right"><b>${eur(r.sub)}</b></td>
              </tr>
            `).join("")}
          </tbody>
        </table>

        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <span class="pill"><span class="muted">Total unidades:</span> <b>${totalUnits()}</b></span>
          <span class="pill"><span class="muted">Total:</span> <b>${eur(totalEur())}</b></span>
        </div>
      `;
    }

    function renderEmail(){
      const rows = state.lines
        .filter(l=>String(l.ref||"").trim() && lineUnits(l)>0)
        .map(l=>{
          const tallas = SIZES.filter(s=>n2(l.qty[s])>0).map(s=>`${s}: ${n2(l.qty[s])}`).join(" · ");
          return { ref:l.ref, desc:l.desc, price:l.price, uds:lineUnits(l), sub:lineSubtotal(l), tallas };
        });

      const subject = `Pedido · Abuela Tata · Invierno AW 26/27`;
      let body = "";
      body += `Hola,\n\n`;
      body += `Adjunto el pedido de Invierno AW 26/27 con el detalle por referencia:\n\n`;

      if(!rows.length){
        body += `— Aún no hay unidades en el pedido.\n\n`;
      } else {
        rows.forEach(r=>{
          body += `REF ${r.ref}\n`;
          body += `Descripción: ${r.desc}\n`;
          body += `Precio/unidad: ${eur(r.price)}\n`;
          body += `Tallas: ${r.tallas}\n`;
          body += `Subtotal (${r.uds} uds): ${eur(r.sub)}\n`;
          body += `----------------------------------------\n`;
        });
        body += `TOTAL UNIDADES: ${totalUnits()}\n`;
        body += `TOTAL: ${eur(totalEur())}\n\n`;
      }

      body += `All the best,\nAntonio\n`;

      $("#emailBox").value = body;
      $("#mailtoBtn").dataset.subject = subject;
    }

    // ===== Autocomplete =====
    function setupAutocomplete(input, box, lineIndex){
      const all = Object.entries(window.PRICE_MAP).map(([ref,v])=>({
        ref:String(ref),
        desc:String(v.desc||""),
        price:Number(v.price||0)
      }));

      let active = -1;
      let current = [];

      function open(list){
        if(!list.length){ box.style.display="none"; box.innerHTML=""; return; }
        current = list;
        active = 0;
        box.innerHTML = list.map((it,i)=>`
          <div class="suggest-item ${i===0?'active':''}" data-i="${i}">
            <div>
              <div class="ref">${it.ref}</div>
              <div class="desc">${it.desc}</div>
            </div>
            <div class="price">${eur(it.price)}</div>
          </div>
        `).join("");
        box.style.display="block";
      }

      function setActive(i){
        active = i;
        [...box.querySelectorAll(".suggest-item")].forEach((el,idx)=>{
          el.classList.toggle("active", idx===active);
        });
      }

      function apply(it){
        const L = state.lines[lineIndex];
        L.ref = it.ref;
        L.desc = it.desc;
        L.price = it.price;
        render();
      }

      input.addEventListener("input", ()=>{
        const v = String(input.value||"").trim();
        if(v.length < 2){ box.style.display="none"; return; }

        let res = all.filter(x=>x.ref.startsWith(v));
        if(!res.length) res = all.filter(x=>x.ref.includes(v));
        res = res.slice(0,12);
        open(res);
      });

      input.addEventListener("keydown", (e)=>{
        if(box.style.display!=="block") return;
        if(e.key==="ArrowDown"){ e.preventDefault(); setActive(Math.min(active+1, current.length-1)); }
        if(e.key==="ArrowUp"){ e.preventDefault(); setActive(Math.max(active-1, 0)); }
        if(e.key==="Enter"){
          if(current[active]){ e.preventDefault(); apply(current[active]); }
        }
        if(e.key==="Escape"){ box.style.display="none"; }
      });

      box.addEventListener("mousedown", (e)=>{
        const item = e.target.closest(".suggest-item");
        if(!item) return;
        e.preventDefault();
        const i = Number(item.dataset.i);
        if(current[i]) apply(current[i]);
      });

      input.addEventListener("change", ()=>{
        const v = String(input.value||"").trim();
        if(!v) return;
        const it = getInfoByRef(v);
        const L = state.lines[lineIndex];
        L.ref = v;
        if(it.desc){ L.desc = it.desc; L.price = it.price; }
        render();
      });

      document.addEventListener("click", (e)=>{
        if(e.target===input) return;
        if(box.contains(e.target)) return;
        box.style.display="none";
      });
    }

    // ===== PDF helpers (con imágenes) =====
    function loadImageAsDataURL(url){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
          try{
            const canvas = document.createElement("canvas");
            canvas.width = img.naturalWidth || 800;
            canvas.height = img.naturalHeight || 800;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img,0,0);
            resolve(canvas.toDataURL("image/jpeg", 0.92));
          }catch(e){
            resolve(null);
          }
        };
        img.onerror = ()=> resolve(null);
        img.src = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      });
    }

    async function makePDF(){
      const { jsPDF } = (window.jspdf || {});
      if(!jsPDF){
        alert("La librería del PDF aún no ha cargado. Recarga con Ctrl+F5 y vuelve a intentarlo.");
        return;
      }

      const rows = state.lines
        .filter(l=>String(l.ref||"").trim() && lineUnits(l)>0)
        .map(l=>{
          const tallas = SIZES.filter(s=>n2(l.qty[s])>0).map(s=>`${s}: ${n2(l.qty[s])}`);
          return { ref:l.ref, desc:l.desc, price:l.price, uds:lineUnits(l), sub:lineSubtotal(l), tallas };
        });

      const doc = new jsPDF({ unit:"pt", format:"a4" });
      const W = doc.internal.pageSize.getWidth();
      const H = doc.internal.pageSize.getHeight();

      let y = 44;
      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("Pedido · Abuela Tata · Invierno AW 26/27", 40, y);

      y += 18;
      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.text(`Total unidades: ${totalUnits()}   ·   Total: ${eur(totalEur())}`, 40, y);

      y += 26;

      if(!rows.length){
        doc.setFont("helvetica","normal");
        doc.text("No hay unidades en el pedido.", 40, y);
        doc.save("pedido_aw26-27.pdf");
        return;
      }

      // Cabecera tabla
      doc.setFont("helvetica","bold");
      doc.setFontSize(10);
      doc.text("IMAGEN", 40, y);
      doc.text("REF", 125, y);
      doc.text("DESCRIPCIÓN", 190, y);
      doc.text("€/UD", W-210, y, { align:"right" });
      doc.text("UDS", W-150, y, { align:"right" });
      doc.text("SUBTOTAL", W-40, y, { align:"right" });

      y += 10;
      doc.setDrawColor(0);
      doc.setLineWidth(0.5);
      doc.line(40, y, W-40, y);
      y += 16;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);

      for(const r of rows){
        // Salto de página
        if(y > H - 110){
          doc.addPage();
          y = 52;
        }

        // Caja de imagen
        const imgX = 40;
        const imgY = y - 6;
        const boxW = 70;
        const boxH = 70;

        doc.setDrawColor(220);
        doc.rect(imgX, imgY, boxW, boxH);

        // Imagen por referencia (si existe)
        const imgUrl = `images/${r.ref}.jpg`;
        const dataUrl = await loadImageAsDataURL(imgUrl);

        if(dataUrl){
          try{
            doc.addImage(dataUrl, "JPEG", imgX, imgY, boxW, boxH);
          }catch(e){
            // si alguna imagen da guerra, no rompe el PDF
          }
        }

        // Texto
        doc.setFont("helvetica","bold");
        doc.text(String(r.ref), 125, y);

        doc.setFont("helvetica","normal");
        doc.text(String(r.desc||""), 190, y, { maxWidth: (W - 40) - 190 - 240 });

        doc.text(eur(r.price), W-210, y, { align:"right" });
        doc.text(String(r.uds), W-150, y, { align:"right" });
        doc.text(eur(r.sub), W-40, y, { align:"right" });

        // chips de tallas (debajo)
        y += 14;
        doc.setFontSize(9);
        doc.setTextColor(80);
        doc.text(r.tallas.join(" · "), 125, y, { maxWidth: W - 165 });
        doc.setTextColor(0);
        doc.setFontSize(10);

        y += 22;
        doc.setDrawColor(230);
        doc.line(40, y, W-40, y);
        y += 14;
      }

      // Totales
      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.text(`TOTAL UNIDADES: ${totalUnits()}`, 40, H-54);
      doc.text(`TOTAL: ${eur(totalEur())}`, W-40, H-54, { align:"right" });

      doc.save("pedido_aw26-27.pdf");
    }

    // ===== Actions =====
    function addLine(){
      state.lines.push(defaultLine());
      render();
    }

    function clearAll(){
      state.lines = [defaultLine()];
      render();
    }

    function handleClick(e){
      const btn = e.target.closest("[data-act]");
      if(!btn) return;
      const act = btn.dataset.act;
      const i = Number(btn.dataset.i);
      const s = btn.dataset.s;

      if(act==="zoom"){
        const L = state.lines[i];
        openImageModal({ src: imgForRef(L.ref), ref: L.ref, desc: L.desc });
        return;
      }

      if(act==="del"){
        state.lines.splice(i,1);
        if(!state.lines.length) state.lines.push(defaultLine());
        render();
        return;
      }
      if(act==="plus"){
        const L = state.lines[i];
        L.qty[s] = n2(L.qty[s]) + 1;
        render();
        return;
      }
      if(act==="minus"){
        const L = state.lines[i];
        L.qty[s] = Math.max(0, n2(L.qty[s]) - 1);
        render();
        return;
      }
    }

    function handleInput(e){
      const el = e.target;
      if(el.dataset.act==="qty"){
        const i = Number(el.dataset.i);
        const s = el.dataset.s;
        state.lines[i].qty[s] = n2(el.value);
        render();
        return;
      }
      if(el.classList.contains("descInput")){
        const i = Number(el.dataset.i);
        state.lines[i].desc = el.value;
        render();
        return;
      }
      if(el.classList.contains("priceInput")){
        const i = Number(el.dataset.i);
        state.lines[i].price = Number(el.value||0);
        render();
        return;
      }
    }

    function copyEmail(){
      const t = $("#emailBox");
      t.focus();
      t.select();
      t.setSelectionRange(0, 999999);
      try{ document.execCommand("copy"); }catch(e){}
    }

    function openMailto(){
      const subject = $("#mailtoBtn").dataset.subject || "Pedido";
      const body = $("#emailBox").value || "";
      const href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = href;
    }

    // =======================
    // INIT
    // =======================
    document.addEventListener("DOMContentLoaded", ()=>{
      try{
        $("#addLineBtn").addEventListener("click", addLine);
        $("#addLineBtn2").addEventListener("click", addLine);

        $("#lines").addEventListener("click", handleClick);
        $("#lines").addEventListener("input", handleInput);

        $("#copyEmailBtn").addEventListener("click", copyEmail);
        $("#mailtoBtn").addEventListener("click", openMailto);

        $("#pdfBtn").addEventListener("click", makePDF);
        $("#pdfBtn2").addEventListener("click", makePDF);

        $("#clearBtn").addEventListener("click", clearAll);

        state.lines = [defaultLine()];
        render();
      }catch(e){
        console.error(e);
        fatal(e);
      }
    });
  })();
  </script>
</body>
</html>
