<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pedidos Invierno ¬∑ Abuela Tata (AW26-27)</title>
<meta name="theme-color" content="#2b2b2b"/>
<style>
:root{
  --bg:#f6f2ee;
  --paper:#ffffff;
  --ink:#1f1f1f;
  --muted:#6b6b6b;
  --line:#e7ded6;
  --dark:#2b2b2b;
  --accent:#b08968;
  --accent2:#7f5539;
  --good:#0f766e;
  --danger:#b42318;
  --shadow:0 18px 55px rgba(31,31,31,.12);
  --shadow2:0 10px 24px rgba(31,31,31,.08);
  --r:18px;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;}
body{
  margin:0;
  background:
    radial-gradient(1200px 700px at 12% -10%, rgba(176,137,104,.22), transparent 55%),
    radial-gradient(900px 650px at 110% 0%, rgba(127,85,57,.16), transparent 50%),
    linear-gradient(180deg, rgba(255,255,255,.25), transparent 30%),
    var(--bg);
  color:var(--ink);
}
header{
  position:sticky;top:0;z-index:50;
  backdrop-filter: blur(14px);
  background:rgba(246,242,238,.9);
  border-bottom:1px solid var(--line);
}
.top{
  max-width:1320px;margin:0 auto;
  padding:14px 16px;
  display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;
}
.brand{display:flex;gap:12px;align-items:center;}
.mark{
  width:44px;height:44px;border-radius:16px;
  background:linear-gradient(135deg, rgba(176,137,104,.95), rgba(127,85,57,.92));
  box-shadow:var(--shadow2);
}
.brand h1{margin:0;font-size:18px;letter-spacing:.2px;}
.brand p{margin:3px 0 0;font-size:12px;color:var(--muted);}
.badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.badge{
  font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);
  background:#fff;
}
.badge.accent{border-color:rgba(176,137,104,.45);background:rgba(176,137,104,.10);}
main{max-width:1320px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1fr;gap:14px;}
.card{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
}
.cardPad{padding:14px;}
h2{margin:0;font-size:15px;}
.sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.35;}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px;}
@media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr);}}
@media (max-width:540px){.grid{grid-template-columns:1fr;}}
label{display:flex;flex-direction:column;gap:6px;font-size:13px;}
input,textarea{
  padding:11px 12px;border-radius:14px;border:1px solid var(--line);
  background:#fff;font-size:14px;outline:none;
}
textarea{min-height:44px;resize:vertical;}
input:focus,textarea:focus{
  border-color:rgba(176,137,104,.65);
  box-shadow:0 0 0 4px rgba(176,137,104,.18);
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-top:12px;}
.row label{flex:1;min-width:260px;}
.btn{
  padding:11px 12px;border-radius:14px;border:1px solid var(--dark);
  background:var(--dark);color:#fff;font-weight:950;font-size:14px;cursor:pointer;
}
.btn:active{transform:translateY(1px);}
.btn.secondary{background:#fff;color:var(--dark);border-color:var(--line);}
.btn.accent{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent;}
.btn.good{background:var(--good);border-color:var(--good);}
.btn.danger{background:var(--danger);border-color:var(--danger);}
/* Product cards */
.products{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:14px;}
@media (max-width:1100px){.products{grid-template-columns:repeat(2,1fr);}}
@media (max-width:720px){.products{grid-template-columns:1fr;}}
.pcard{
  border:1px solid var(--line);
  border-radius:18px;
  background:linear-gradient(180deg,#fff, #fbf7f3);
  overflow:hidden;
}
.pimg{
  position:relative;
  aspect-ratio: 16 / 11;
  background:
    radial-gradient(600px 240px at 20% 20%, rgba(176,137,104,.22), transparent 55%),
    radial-gradient(520px 250px at 80% 10%, rgba(127,85,57,.12), transparent 55%),
    #f5efe8;
  display:flex;align-items:center;justify-content:center;
  cursor:zoom-in;
}
.pimg img{width:100%;height:100%;object-fit:cover;display:block;}
.pimg .ph{
  width:100%;height:100%;
  display:flex;align-items:center;justify-content:center;
  font-weight:1100;font-size:18px;color:#3a2a1f;
  letter-spacing:.3px;
}
.pmeta{padding:12px 12px 10px;}
.pmeta .ref{font-weight:1100;}
.pmeta .desc{margin-top:4px;font-size:12px;color:var(--muted);line-height:1.25;}
.pmeta .price{margin-top:8px;font-weight:1100;}
.sizes{padding:0 12px 12px;display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
@media (max-width:420px){.sizes{grid-template-columns:1fr;}}
.sline{
  border:1px solid var(--line);
  background:#fff;border-radius:14px;
  display:flex;justify-content:space-between;align-items:center;
  padding:9px 10px;
}
.sline b{font-size:13px;}
.ctr{display:flex;align-items:center;gap:8px;}
.ctr button{
  width:30px;height:30px;border-radius:12px;
  border:1px solid var(--line);background:#fff;cursor:pointer;
  font-weight:1100;
}
.ctr span{min-width:18px;text-align:center;font-weight:1100;}
.pfoot{padding:10px 12px 12px;border-top:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;align-items:center;}
.small{font-size:12px;color:var(--muted);}
.kpi{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.kpiBox{padding:8px 10px;border-radius:14px;border:1px solid var(--line);background:rgba(176,137,104,.08);}
.kpiBox b{font-size:14px;}
.kpiBox span{font-size:12px;color:var(--muted);margin-left:6px;}
.stickyTotal{
  position:sticky;bottom:0;z-index:40;
  border-top:1px solid var(--line);
  background:rgba(255,255,255,.94);
  backdrop-filter: blur(14px);
}
.totalBar{max-width:1320px;margin:0 auto;padding:12px 16px;display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;}
.bigTotal{font-size:20px;font-weight:1200;}
/* modal zoom */
#zoomBg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:90;}
#zoom{position:fixed;left:50%;top:4%;transform:translateX(-50%);
  width:min(980px,94vw);max-height:92vh;background:#fff;border:1px solid var(--line);
  border-radius:18px;box-shadow:0 28px 80px rgba(0,0,0,.22);
  display:none;z-index:100;overflow:hidden;
}
#zoom .zhead{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);}
#zoom .zhead b{font-size:13px;}
#zoom img{width:100%;height:auto;display:block;max-height:82vh;object-fit:contain;background:#111;}
.toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111827;color:#fff;
padding:10px 12px;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.18);display:none;z-index:999;font-size:13px;}
</style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="mark" aria-hidden="true"></div>
      <div>
        <h1>Pedidos Invierno ¬∑ Abuela Tata</h1>
        <p>AW26-27 ¬∑ Fotos /images/REF.jpg ¬∑ Env√≠o por email a <b>info@abuelatata.com</b></p>
      </div>
    </div>
    <div class="badges">
      <div class="badge accent"><b>Fecha</b> <span id="fechaBadge">12/02/2026</span></div>
      <div class="badge"><b>Guardar</b> autom√°tico</div>
      <div class="badge"><b>Showroom</b> clic para ampliar</div>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="cardPad">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <h2>Datos del cliente</h2>
          <div class="sub">Campos marcados con * obligatorios. Fecha del pedido autom√°tica.</div>
        </div>
        <div class="badge"><b>Fecha pedido:</b> 12/02/2026</div>
      </div>

      <div class="grid">
        <label>Nombre fiscal *<input id="fiscalName" placeholder="Raz√≥n social"/></label>
        <label>NIF / CIF *<input id="taxId" placeholder="B12345678 / 12345678X"/></label>
        <label>Nombre tienda *<input id="shopName" placeholder="Nombre comercial"/></label>
        <label>Persona de contacto *<input id="contactPerson" placeholder="Nombre y apellidos"/></label>

        <label>Email *<input id="email" placeholder="correo@tienda.com" inputmode="email"/></label>
        <label>Tel√©fono<input id="phone" placeholder="+34 ..."/></label>
        <label>Direcci√≥n fiscal<input id="address" placeholder="Calle, n√∫mero"/></label>
        <label>C√≥digo postal<input id="zip" placeholder="41000" inputmode="numeric"/></label>

        <label>Poblaci√≥n<input id="city" placeholder="Ciudad"/></label>
        <label>Provincia<input id="province" placeholder="Provincia"/></label>
        <label style="grid-column: span 2;">Observaciones<textarea id="notes" placeholder="Entrega, comentarios, etc."></textarea></label>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="cardPad">
      <h2>A√±adir art√≠culos</h2>
      <div class="sub">Escribe la referencia y pulsa ‚ÄúA√±adir‚Äù. La app muestra foto (si existe) y tallas seg√∫n prefijo.</div>

      <div class="row">
        <label>Referencia
          <input id="refInput" placeholder="Ej: 1299426" autocomplete="off"/>
        </label>
        <button class="btn accent" type="button" onclick="addProduct()">Ôºã A√±adir</button>
        <button class="btn secondary" type="button" onclick="exportCSV()">üìÑ CSV</button>
        <button class="btn danger" type="button" onclick="clearAll()">üóëÔ∏è Vaciar</button>
      </div>
      <div class="sub" id="hint">Fotos: sube una imagen en <b>/images/REFERENCIA.jpg</b> (ej: /images/1299426.jpg). Clic en la foto para ampliar.</div>
    </div>

    <div class="products" id="products"></div>
  </section>
</main>

<div class="stickyTotal">
  <div class="totalBar">
    <div>
      <div class="small">Total pedido</div>
      <div class="bigTotal" id="totalEuros">0,00 ‚Ç¨</div>
    </div>
    <div class="kpi">
      <div class="kpiBox"><b id="totalRefs">0</b><span>refs</span></div>
      <div class="kpiBox"><b id="totalUnits">0</b><span>uds</span></div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn secondary" type="button" onclick="previewEmail()">üëÄ Ver email</button>
      <button class="btn good" type="button" onclick="sendEmail()">‚úâÔ∏è Enviar pedido</button>
    </div>
  </div>
</div>

<!-- Zoom modal -->
<div id="zoomBg" onclick="closeZoom()"></div>
<div id="zoom">
  <div class="zhead">
    <b id="zoomTitle">Imagen</b>
    <button class="btn secondary" type="button" onclick="closeZoom()">Cerrar</button>
  </div>
  <img id="zoomImg" alt=""/>
</div>

<!-- Email modal -->
<div id="emailBg" onclick="closeEmail()" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:90;"></div>
<div id="emailModal" style="position:fixed;left:50%;top:6%;transform:translateX(-50%);width:min(980px,94vw);max-height:88vh;background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 28px 80px rgba(0,0,0,.22);display:none;z-index:100;overflow:hidden;">
  <div style="padding:10px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
    <b>Vista previa del email</b>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn secondary" type="button" onclick="closeEmail()">Cerrar</button>
      <button class="btn good" type="button" onclick="sendEmail()">Enviar</button>
    </div>
  </div>
  <div style="padding:12px;overflow:auto;max-height:76vh;">
    <div class="sub"><b>Para:</b> info@abuelatata.com</div>
    <div class="sub"><b>Asunto:</b> <span id="emailSubject"></span></div>
    <pre id="emailBody" style="white-space:pre-wrap;word-wrap:break-word;background:#fbf7f3;border:1px solid var(--line);padding:12px;border-radius:14px;font-size:12px;"></pre>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const TO_EMAIL = "info@abuelatata.com";
const TARIFA = {"0899426": {"desc": "HEADBAND", "price": 9.25}, "1299426": {"desc": "BABY DRESS SET", "price": 53.8}, "1399426": {"desc": "BABY DRESS SET(NO BONNET)", "price": 49.95}, "2599426": {"desc": "DRESS", "price": 50.65}, "4399426": {"desc": "BOY SET", "price": 31.75}, "0899427": {"desc": "HEADBAND", "price": 9.25}, "1299427": {"desc": "BABY DRESS SET", "price": 40.65}, "1399427": {"desc": "BABY DRESS SET(NO BONNET)", "price": 34.5}, "2599427": {"desc": "DRESS", "price": 38.85}, "4399427": {"desc": "BOY SET", "price": 33.35}, "43099427": {"desc": "BOY SET", "price": 33.35}, "0899428": {"desc": "HEADBAND", "price": 9.25}, "1199428": {"desc": "ROMPER", "price": 20.25}, "1299428": {"desc": "BABY DRESS SET", "price": 53.35}, "1399428": {"desc": "BABY DRESS SET(NO BONNET)", "price": 50.75}, "2599428": {"desc": "DRESS", "price": 51.7}, "1299429": {"desc": "BABY DRESS SET", "price": 47.15}, "1399429": {"desc": "BABY DRESS SET(NO BONNET)", "price": 44.85}, "2599429": {"desc": "DRESS", "price": 51.7}, "0899430": {"desc": "HEADBAND", "price": 9.25}, "1299430": {"desc": "BABY DRESS SET", "price": 39.7}, "1399430": {"desc": "BABY DRESS SET(NO BONNET)", "price": 36.95}, "2599430": {"desc": "DRESS", "price": 38.5}, "4399430": {"desc": "BOY SET", "price": 31.35}, "0899431": {"desc": "HEADBAND", "price": 9.25}, "1299431": {"desc": "BABY DRESS SET", "price": 40.45}, "1399431": {"desc": "BABY DRESS SET(NO BONNET)", "price": 37.95}, "2599431": {"desc": "DRESS", "price": 39.8}, "3099431": {"desc": "BABY BOY SET", "price": 24.65}, "0809432": {"desc": "HEADBAND", "price": 9.25}, "1209432": {"desc": "BABY DRESS SET", "price": 39.15}, "1309432": {"desc": "BABY DRESS SET(NO BONNET)", "price": 36.95}, "2509432": {"desc": "DRESS", "price": 38.95}, "4309432": {"desc": "BOY SET", "price": 29.75}, "0899432": {"desc": "HEADBAND", "price": 9.25}, "1299432": {"desc": "BABY DRESS SET", "price": 41.95}, "1399432": {"desc": "BABY DRESS SET(NO BONNET)", "price": 39.25}, "2599432": {"desc": "DRESS", "price": 41.65}, "4399432": {"desc": "BOY SET", "price": 30.75}, "0899433": {"desc": "HEADBAND", "price": 9.25}, "1299433": {"desc": "BABY DRESS SET", "price": 46.75}, "1399433": {"desc": "BABY DRESS SET(NO BONNET)", "price": 45.25}, "2599433": {"desc": "DRESS", "price": 49.25}, "0899434": {"desc": "HEADBAND", "price": 9.25}, "1199434": {"desc": "ROMPER", "price": 22.65}, "1299434": {"desc": "BABY DRESS SET", "price": 44.45}, "1399434": {"desc": "BABY DRESS SET(NO BONNET)", "price": 39.15}, "2599434": {"desc": "DRESS", "price": 37.7}, "0805435": {"desc": "HEADBAND", "price": 9.25}, "1205435": {"desc": "BABY DRESS SET", "price": 41.5}, "1305435": {"desc": "BABY DRESS SET(NO BONNET)", "price": 39.35}, "2505435": {"desc": "DRESS", "price": 43.1}, "0899435": {"desc": "HEADBAND", "price": 9.25}, "1208435": {"desc": "BABY DRESS SET", "price": 41.5}, "1308435": {"desc": "BABY DRESS SET(NO BONNET)", "price": 39.35}, "2508435": {"desc": "DRESS", "price": 43.1}, "220257": {"desc": "RED COAT", "price": 40.75}, "220357": {"desc": "NAVY COAT", "price": 40.75}, "220657": {"desc": "CAMEL COAT", "price": 40.75}, "220158": {"desc": "PINK COAT", "price": 37.65}, "220258": {"desc": "RED COAT", "price": 37.65}, "220358": {"desc": "NAVY COAT", "price": 37.65}, "220658": {"desc": "CAMEL COAT", "price": 37.65}, "220159": {"desc": "PINK COAT", "price": 39.35}, "220259": {"desc": "RED COAT", "price": 39.35}, "220359": {"desc": "NAVY COAT", "price": 39.35}, "220659": {"desc": "CAMEL COAT", "price": 39.35}, "220160": {"desc": "PINK COAT", "price": 37.75}, "220260": {"desc": "RED COAT", "price": 37.75}, "220360": {"desc": "NAVY COAT", "price": 37.75}, "220660": {"desc": "CAMEL COAT", "price": 37.75}};
const SIZES_BABY = ["3M", "6M", "9M", "12M", "18M", "2A", "3A", "4A"];
const SIZES_KID  = ["12M", "18M", "2A", "3A", "4A", "5A", "6A", "8A", "10A", "12A"];

const RULES = {
  babyPrefixes: ["11","12","13"],
  kidPrefixes: ["22","25","43"],
};

const STORAGE_KEY = "abuelatata_aw2627_showroom_v3";

const qs = (s)=>document.querySelector(s);
function euro(n){ return (Number(n||0)).toFixed(2).replace(".", ",")+" ‚Ç¨"; }
function toast(msg) {
  const t=qs("#toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(window.__toastT);
  window.__toastT=setTimeout(()=>t.style.display="none", 2200);
}

function pref(ref){ return String(ref||"").trim().slice(0,2); }
function sizesFor(ref){
  const p=pref(ref);
  if(RULES.babyPrefixes.includes(p)) return SIZES_BABY;
  if(RULES.kidPrefixes.includes(p))  return SIZES_KID;
  return [];
}

function initialPlaceholder(ref){
  const p=pref(ref);
  const map={"11":"Pelele","12":"Jesusito c/ capota","13":"Jesusito s/ capota","22":"Abrigo","25":"Vestido de vuelo","43":"Conjunto ni√±o"};
  return map[p] ? (map[p] + " ¬∑ " + ref) : ref;
}

function productId(ref){ return "p_"+ref; }

function addProduct(){
  const ref = (qs("#refInput").value||"").trim();
  if(!ref || ref.length<2) return;

  const item = TARIFA[ref];
  if(!item){ toast("Esa referencia no est√° en la tarifa"); return; }

  const existing = document.getElementById(productId(ref));
  if(existing){ existing.scrollIntoView({behavior:"smooth", block:"center"}); toast("Ya estaba a√±adida"); qs("#refInput").value=""; return; }

  const sizes = sizesFor(ref);
  if(!sizes.length){ toast("Prefijo sin tallas configuradas"); return; }

  const card = document.createElement("div");
  card.className="pcard";
  card.id=productId(ref);

  const imgUrl = `images/${ref}.jpg`;

  card.innerHTML = `
    <div class="pimg" title="Clic para ampliar">
      <img alt="${ref}" src="${imgUrl}" style="display:none;"/>
      <div class="ph">${initialPlaceholder(ref)}</div>
    </div>
    <div class="pmeta">
      <div class="ref">${ref}</div>
      <div class="desc">${item.desc || ""}</div>
      <div class="price">${euro(item.price)} <span class="small">/ ud</span></div>
    </div>
    <div class="sizes"></div>
    <div class="pfoot">
      <div>
        <div class="small">Subtotal</div>
        <b class="subtotal">${euro(0)}</b>
      </div>
      <button class="btn secondary" type="button" onclick="removeProduct('${ref}')">Quitar</button>
    </div>
  `;

  // image handling
  const img = card.querySelector("img");
  const ph  = card.querySelector(".ph");
  img.addEventListener("load", ()=>{ img.style.display="block"; ph.style.display="none"; });
  img.addEventListener("error", ()=>{ img.style.display="none"; ph.style.display="flex"; });

  card.querySelector(".pimg").addEventListener("click", ()=>{ openZoom(ref, imgUrl); });

  const sizesBox = card.querySelector(".sizes");
  sizes.forEach(s=>{
    const row = document.createElement("div");
    row.className="sline";
    row.innerHTML = `
      <b>${s}</b>
      <div class="ctr">
        <button type="button" aria-label="menos">‚àí</button>
        <span>0</span>
        <button type="button" aria-label="m√°s">+</button>
      </div>
    `;
    const btnMinus=row.querySelectorAll("button")[0];
    const btnPlus=row.querySelectorAll("button")[1];
    const span=row.querySelector("span");
    btnMinus.addEventListener("click", ()=>{
      const v=Math.max(0, parseInt(span.textContent||"0",10)-1);
      span.textContent=String(v);
      recalc();
      save();
    });
    btnPlus.addEventListener("click", ()=>{
      const v=parseInt(span.textContent||"0",10)+1;
      span.textContent=String(v);
      recalc();
      save();
    });
    sizesBox.appendChild(row);
  });

  qs("#products").appendChild(card);
  qs("#refInput").value="";
  recalc();
  save();
  toast("A√±adido ‚úîÔ∏è");
}

function removeProduct(ref){
  const el=document.getElementById(productId(ref));
  if(el) el.remove();
  recalc();
  save();
}

function recalc(){
  let totalUnits=0;
  let totalEuros=0;

  document.querySelectorAll(".pcard").forEach(card=>{
    const ref = card.id.replace("p_","");
    const price = TARIFA[ref]?.price || 0;
    let units=0;
    card.querySelectorAll(".sline").forEach(r=>{
      units += parseInt(r.querySelector("span").textContent||"0",10) || 0;
    });
    const sub = units * price;
    card.querySelector(".subtotal").textContent = euro(sub);
    totalUnits += units;
    totalEuros += sub;
  });

  qs("#totalUnits").textContent = String(totalUnits);
  qs("#totalRefs").textContent  = String(document.querySelectorAll(".pcard").length);
  qs("#totalEuros").textContent = euro(totalEuros);
}

function clientData(){
  return {
    fiscalName:(qs("#fiscalName").value||"").trim(),
    taxId:(qs("#taxId").value||"").trim(),
    shopName:(qs("#shopName").value||"").trim(),
    contactPerson:(qs("#contactPerson").value||"").trim(),
    email:(qs("#email").value||"").trim(),
    phone:(qs("#phone").value||"").trim(),
    address:(qs("#address").value||"").trim(),
    zip:(qs("#zip").value||"").trim(),
    city:(qs("#city").value||"").trim(),
    province:(qs("#province").value||"").trim(),
    notes:(qs("#notes").value||"").trim(),
  };
}

function validateClient(){
  const c=clientData();
  if(!c.fiscalName || !c.taxId || !c.shopName || !c.contactPerson || !c.email){
    toast("Faltan datos obligatorios del cliente (*)");
    return false;
  }
  return true;
}

function buildOrder(){
  const c=clientData();
  const fecha = "12/02/2026";
  const lines=[];

  document.querySelectorAll(".pcard").forEach(card=>{
    const ref = card.id.replace("p_","");
    const item=TARIFA[ref];
    const price=item?.price||0;
    const sizes=[];
    let units=0;
    card.querySelectorAll(".sline").forEach(r=>{
      const size=r.querySelector("b").textContent;
      const qty=parseInt(r.querySelector("span").textContent||"0",10)||0;
      if(qty>0){ sizes.push(`${size}:${qty}`); units += qty; }
    });
    if(units>0) {
      lines.push({
        ref,
        desc:item?.desc||"",
        price,
        sizes: sizes.join("  "),
        units,
        amount: units*price
      });
    }
  });

  return {c, fecha, lines};
}

function buildEmail(){
  const o=buildOrder();
  const c=o.c;
  const totalEuros = qs("#totalEuros").textContent;
  const totalUnits = qs("#totalUnits").textContent;

  const subject = `PEDIDO INVIERNO AW26-27 ‚Äî ${c.shopName} ‚Äî 2026-02-12`;

  let body = "PEDIDO INVIERNO ‚Äî ABUELA TATA (AW26-27)\n";
  body += `Fecha: ${o.fecha}\n\n`;
  body += "DATOS CLIENTE\n";
  body += `Nombre fiscal: ${c.fiscalName}\n`;
  body += `NIF/CIF: ${c.taxId}\n`;
  body += `Nombre tienda: ${c.shopName}\n`;
  body += `Contacto: ${c.contactPerson}\n`;
  body += `Email: ${c.email}\n`;
  if(c.phone) body += `Tel√©fono: ${c.phone}\n`;
  if(c.address) body += `Direcci√≥n: ${c.address}\n`;
  if(c.zip || c.city || c.province) body += `CP/Poblaci√≥n/Provincia: ${c.zip} ${c.city} ${c.province}\n`;
  if(c.notes) body += `Observaciones: ${c.notes}\n`;
  body += "\nDETALLE (tallas)\n";

  if(o.lines.length===0) {
    body += "- (sin cantidades a√∫n)\n";
  } else {
    o.lines.forEach(l=>{
      body += `- ${l.ref} | ${l.desc} | ${l.sizes} | Uds:${l.units} | ${euro(l.amount)}\n`;
    });
  }
  body += `\nTOTAL: ${totalEuros} (Uds: ${totalUnits})\n`;
  body += "\n‚Äî\nGenerado desde la app de pedidos Invierno (Abuela Tata).\n";
  return {subject, body};
}

function previewEmail(){
  if(!validateClient()) return;
  const mail=buildEmail();
  qs("#emailSubject").textContent = mail.subject;
  qs("#emailBody").textContent = mail.body;
  qs("#emailBg").style.display="block";
  qs("#emailModal").style.display="block";
}
function closeEmail(){
  qs("#emailBg").style.display="none";
  qs("#emailModal").style.display="none";
}
function sendEmail(){
  if(!validateClient()) return;
  const mail=buildEmail();
  const href = "mailto:" + encodeURIComponent(TO_EMAIL) +
    "?subject=" + encodeURIComponent(mail.subject) +
    "&body=" + encodeURIComponent(mail.body);
  window.location.href = href;
}

function openZoom(ref, url){
  qs("#zoomTitle").textContent = ref;
  const img = qs("#zoomImg");
  img.src = url;
  img.alt = ref;
  qs("#zoomBg").style.display="block";
  qs("#zoom").style.display="block";
}
function closeZoom(){
  qs("#zoomBg").style.display="none";
  qs("#zoom").style.display="none";
  qs("#zoomImg").src = "";
}

function exportCSV(){
  if(!validateClient()) return;
  const o=buildOrder();
  const rows=[];
  rows.push(["fecha","nombre_fiscal","nif_cif","tienda","contacto","email","telefono","ref","desc","tallas","uds","precio","importe"]);
  o.lines.forEach(l=>{
    rows.push([
      o.fecha, o.c.fiscalName, o.c.taxId, o.c.shopName, o.c.contactPerson, o.c.email, o.c.phone,
      l.ref, l.desc, l.sizes, String(l.units), String(l.price), String(l.amount.toFixed(2))
    ]);
  });
  const csv = rows.map(r => r.map(v => '"' + String(v||"").replaceAll('"','""') + '"').join(";")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=`pedido_AW26-27_${o.c.shopName||"cliente"}_2026-02-12.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  toast("CSV descargado ‚úîÔ∏è");
}

function clearAll(){
  if(!confirm("¬øVaciar pedido y datos?")) return;
  // clear products
  qs("#products").innerHTML="";
  // clear client
  ["#fiscalName","#taxId","#shopName","#contactPerson","#email","#phone","#address","#zip","#city","#province","#notes"].forEach(id=>{ qs(id).value=""; });
  recalc();
  save();
  toast("Vaciado");
}

function save(){
  const payload={
    client: clientData(),
    products: []
  };
  document.querySelectorAll(".pcard").forEach(card=>{
    const ref = card.id.replace("p_","");
    const qty={};
    card.querySelectorAll(".sline").forEach(r=>{
      const size=r.querySelector("b").textContent;
      const v=parseInt(r.querySelector("span").textContent||"0",10)||0;
      qty[size]=v;
    });
    payload.products.push({ref, qty});
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
}

function load(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const p=JSON.parse(raw);
    if(p.client){
      qs("#fiscalName").value=p.client.fiscalName||"";
      qs("#taxId").value=p.client.taxId||"";
      qs("#shopName").value=p.client.shopName||"";
      qs("#contactPerson").value=p.client.contactPerson||"";
      qs("#email").value=p.client.email||"";
      qs("#phone").value=p.client.phone||"";
      qs("#address").value=p.client.address||"";
      qs("#zip").value=p.client.zip||"";
      qs("#city").value=p.client.city||"";
      qs("#province").value=p.client.province||"";
      qs("#notes").value=p.client.notes||"";
    }
    if(Array.isArray(p.products)){
      p.products.forEach(pr=>{
        if(TARIFA[pr.ref]){
          // add product
          qs("#refInput").value=pr.ref;
          addProduct();
          const card=document.getElementById(productId(pr.ref));
          if(card && pr.qty){
            card.querySelectorAll(".sline").forEach(r=>{
              const size=r.querySelector("b").textContent;
              const span=r.querySelector("span");
              if(pr.qty[size] != null) span.textContent=String(pr.qty[size]);
            });
          }
        }
      });
    }
  }catch(e){}
  recalc();
}

function init(){
  // autosave client fields
  ["#fiscalName","#taxId","#shopName","#contactPerson","#email","#phone","#address","#zip","#city","#province","#notes"].forEach(id=>{
    qs(id).addEventListener("input", save);
    qs(id).addEventListener("change", save);
  });
  qs("#refInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") addProduct(); });
  load();
}
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwAJGWUilQXyjanjSgGwuawEvhiZZIsMmnsyFLLtXDB-OsHhBGr1ORqsPHs1fSO6oTPqg/exec";

async function sendEmail() {
  if (!validateClient()) return;

  const order = buildOrder();
  const mail = buildEmail();

  try {
    const response = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        order: order,
        subject: mail.subject,
        body: mail.body,
        toClient: document.querySelector("#email").value.trim()
      }),
      headers: {
        "Content-Type": "text/plain;charset=utf-8"
      }
    });

    const result = await response.text();
    alert("Pedido enviado correctamente ‚úÖ");
  } catch (error) {
    alert("Error al enviar el pedido ‚ùå");
    console.error(error);
  }
}  
init();
</script>
</body>
</html>
