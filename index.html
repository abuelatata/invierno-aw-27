<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Abuela Tata · Invierno AW 26/27 · Pedidos</title>

  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#fbfaf8;
      --card:#ffffff;
      --ink:#141414;
      --muted:rgba(20,20,20,.62);
      --line:rgba(0,0,0,.10);
      --shadow:0 18px 40px rgba(0,0,0,.08);
      --radius:18px;

      /* VERDE AGUA (botones) */
      --aqua:#62c7c1;
      --aqua2:#41b6af;
      --aquaInk:#073b3a;

      --bad:#b00020;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 14px 120px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 6px 14px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .brand .logo{
      width:44px;height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      overflow:hidden;
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .brand .logo img{width:100%;height:100%;object-fit:contain}
    .brand .ttl{min-width:0}
    .brand .ttl h1{margin:0;font-size:1.05rem}
    .brand .ttl p{margin:2px 0 0;color:var(--muted);font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      flex-wrap:wrap;
      background: linear-gradient(180deg,#fff,rgba(255,255,255,.9));
    }
    .card .hd h2{margin:0;font-size:1.02rem}
    .card .bd{padding:14px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{color:var(--muted);font-size:.94rem;line-height:1.35;margin:8px 0 0}

    /* BOTONES: todos verde agua */
    .btn{
      border:1px solid rgba(7,59,58,.18);
      background: linear-gradient(180deg,var(--aqua),var(--aqua2));
      color:var(--aquaInk);
      border-radius: 14px;
      padding: 11px 14px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      transition: transform .06s ease, box-shadow .12s ease;
      min-height: 44px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ box-shadow: 0 14px 22px rgba(0,0,0,.08); }
    .btn:active{ transform: translateY(1px); }
    .btn.small{padding:9px 12px;border-radius:12px;min-height:40px}
    .btn.icon{width:44px;height:44px;justify-content:center;padding:10px}

    /* Vaciar pedido en rojo (alerta) */
    .btn.danger{
      background:#fff;
      color:var(--bad);
      border-color: rgba(176,0,32,.22);
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:999px;padding:7px 11px;background:#fff;font-weight:900;
      min-height: 40px;
    }
    .money{font-weight:900}
    .muted{color:var(--muted)}

    /* Line item */
    .line{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin-bottom:12px;
      background:rgba(255,255,255,.92);
    }
    .lineTop{display:flex;gap:12px;align-items:flex-start}
    @media (max-width: 520px){ .lineTop{gap:10px} }

    .pimgBtn{
      width:82px;height:82px;border-radius:16px;border:1px solid var(--line);
      background:#fff;overflow:hidden;flex:0 0 auto;
      padding:0; cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      -webkit-tap-highlight-color: transparent;
    }
    .pimgBtn img{width:100%;height:100%;object-fit:cover;display:block}

    .meta{flex:1;min-width:0}
    .meta .r1{
      display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
    }
    .meta .r2{margin-top:8px;color:var(--muted);font-size:.94rem;line-height:1.25}
    .meta .r2 b{color:var(--ink)}

    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 240px; flex:1;
    }
    @media (max-width: 520px){
      .field{min-width: 100%}
      .pimgBtn{width:76px;height:76px}
    }
    label{font-size:.84rem;color:var(--muted);font-weight:850}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-size:1rem;
      min-height: 44px;
    }
    textarea{min-height:170px;resize:vertical}

    /* Autocomplete */
    .suggest-wrap{position:relative;flex:1;min-width:240px}
    .suggest{
      position:absolute;left:0;right:0;top:76px;
      z-index:9999;background:rgba(255,255,255,.98);
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      box-shadow:0 14px 30px rgba(0,0,0,.12);
      overflow:hidden;
      max-height:300px;overflow-y:auto;
      display:none;
    }
    .suggest-item{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding:10px 12px;cursor:pointer;border-bottom:1px solid rgba(0,0,0,.06);
    }
    .suggest-item:last-child{border-bottom:0}
    .suggest-item:hover,.suggest-item.active{background:rgba(0,0,0,.05)}
    .suggest-item .ref{font-weight:900}
    .suggest-item .desc{font-size:.92rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:62vw}
    .suggest-item .price{font-weight:900;white-space:nowrap}

    /* DETAILS tallas */
    details.sizesDetails{
      margin-top:12px;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:#fff;
      overflow:hidden;
    }
    details.sizesDetails summary{
      list-style:none;
      cursor:pointer;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    details.sizesDetails summary::-webkit-details-marker{display:none}
    .sumLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background:rgba(98,199,193,.18);
      color:var(--aquaInk);
      font-weight:900;
      min-height: 34px;
      white-space:nowrap;
    }
    .sizesBody{padding:12px;border-top:1px solid rgba(0,0,0,.08)}
    .sizes{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:8px;
    }
    @media (max-width: 980px){ .sizes{ grid-template-columns: repeat(5, minmax(0, 1fr)); } }
    @media (max-width: 740px){ .sizes{ grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    @media (max-width: 520px){ .sizes{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }

    .sz{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      min-height: 44px;
      overflow:hidden;
    }
    .sz .t{font-weight:900;font-size:.9rem;white-space:nowrap}
    .step{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
      flex:0 0 auto;
      padding:0 4px;
      touch-action: manipulation;
    }
    .step button{
      width:34px;height:34px;border:0;background:transparent;cursor:pointer;font-weight:900;
      font-size: 1.05rem;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .step input{
      width:44px;border:0;border-left:1px solid rgba(0,0,0,.10);border-right:1px solid rgba(0,0,0,.10);
      border-radius:0;padding:0;text-align:center;font-weight:900;min-height:34px;
      outline:none;
      background:#fff;
    }

    /* Resumen */
    .tableScroll{overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:14px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px;min-width: 720px;}
    th{font-size:.82rem;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);text-align:left;padding:0 8px}
    td{background:#fff;border:1px solid var(--line);padding:10px 8px;vertical-align:top}
    td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
    td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
    .nowrap{white-space:nowrap}
    .right{text-align:right}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:4px 8px;font-weight:900;background:#fff;font-size:.86rem}

    /* Barra inferior fija */
    .bar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      z-index:1000;
    }
    .barin{
      max-width:1120px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .totals{display:flex;gap:10px;flex-wrap:wrap}

    /* Lightbox */
    .modal{ position:fixed; inset:0; display:none; z-index:2000; }
    .modal[aria-hidden="false"]{ display:block; }
    .modal__backdrop{position:absolute; inset:0;background: rgba(0,0,0,.45);backdrop-filter: blur(6px);}
    .modal__panel{
      position:absolute;left:50%; top:50%;transform: translate(-50%,-50%);
      width:min(820px, calc(100vw - 24px));
      background:#fff;border:1px solid rgba(0,0,0,.12);
      border-radius: 20px;box-shadow: 0 28px 60px rgba(0,0,0,.20);
      overflow:hidden;
    }
    .modal__close{ position:absolute; top:10px; right:10px; z-index:2; }
    .modal__content{ padding: 14px; }
    .modal__content img{width:100%;height:auto;border-radius: 16px;border:1px solid rgba(0,0,0,.10);background:#fff;}
    .modal__cap{ margin-top:10px; }
    .modal__ref{ font-weight: 900; font-size: 1rem; }
    .modal__desc{ color: rgba(0,0,0,.65); margin-top:2px; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">
          <img src="images/logo.png" alt="Abuela Tata"
               onerror="this.style.display='none';this.parentElement.textContent='AT';this.parentElement.style.fontWeight='900';" />
        </div>
        <div class="ttl">
          <h1>Pedidos · Invierno AW 26/27</h1>
          <p><span id="orderDateLabel"></span> · Móvil / tablet / PC</p>
        </div>
      </div>

      <button class="btn" id="addLineBtn" type="button">Añadir referencia</button>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Pedido</h2>
          <div class="row">
            <span class="pill"><span class="muted">Fecha:</span> <b id="orderDatePill"></b></span>
            <span class="pill"><span class="muted">Unidades:</span> <span id="totalUds" class="money">0</span></span>
            <span class="pill"><span class="muted">Total:</span> <span id="totalEur" class="money">0,00 €</span></span>
          </div>
        </div>
        <div class="bd">
          <p class="hint">
            Escribe “12”, “25”, “43”… y te sale el desplegable con referencia, descripción y precio.
            Las tallas cambian solas según el tipo (12/13/30/31 bebé, 25/22/43 niño, 08 TU).
          </p>

          <div id="lines"></div>

          <div class="row">
            <button class="btn" id="addLineBtn2" type="button">Añadir otra referencia</button>
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="hd">
          <h2>Resumen · Email · PDF</h2>
          <div class="row">
            <button class="btn" id="copyEmailBtn" type="button">Copiar email</button>
            <button class="btn" id="mailtoBtn" type="button">Abrir email</button>
            <button class="btn" id="pdfBtn" type="button">Generar PDF</button>
          </div>
        </div>
        <div class="bd">
          <div id="summaryWrap"></div>

          <div style="height:12px"></div>

          <label for="emailBox">Email (neutro, sin firma)</label>
          <textarea id="emailBox" spellcheck="false"></textarea>

          <p class="hint">
            Para ver cambios tras un commit, abre la web con <b>?v=123</b> (cambia el número).
          </p>
        </div>
      </aside>
    </div>
  </div>

  <div class="bar">
    <div class="barin">
      <div class="totals">
        <span class="pill"><span class="muted">Fecha:</span> <b id="orderDatePill2"></b></span>
        <span class="pill"><span class="muted">Unidades:</span> <span id="totalUds2" class="money">0</span></span>
        <span class="pill"><span class="muted">Total:</span> <span id="totalEur2" class="money">0,00 €</span></span>
      </div>
      <div class="row">
        <button class="btn danger" id="clearBtn" type="button">Vaciar pedido</button>
        <button class="btn" id="pdfBtn2" type="button">PDF</button>
      </div>
    </div>
  </div>

  <!-- Visor de imagen -->
  <div id="imgModal" class="modal" aria-hidden="true">
    <div class="modal__backdrop" data-close="1"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-label="Imagen de producto">
      <button class="btn icon modal__close" data-close="1" title="Cerrar" type="button">✕</button>
      <div class="modal__content">
        <img id="imgModalPic" alt="Imagen ampliada" />
        <div class="modal__cap">
          <div id="imgModalRef" class="modal__ref"></div>
          <div id="imgModalDesc" class="modal__desc"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // =======================
    // TARIFA (tu bloque)
    // =======================
    window.PRICE_MAP = {"0899426":{"desc":"Diadema","price":9.25},"1299426":{"desc":"Jesusito con Capota","price":53.8},"1399426":{"desc":"Jesusito sin Capota","price":49.95},"2599426":{"desc":"Vestido","price":50.65},"4399426":{"desc":"Conjunto de Niño","price":31.75},"0899427":{"desc":"Diadema","price":9.25},"1299427":{"desc":"Jesusito con Capota","price":40.65},"1399427":{"desc":"Jesusito sin Capota","price":34.5},"2599427":{"desc":"Vestido","price":38.85},"4399427":{"desc":"Conjunto de Niño","price":33.35},"43099427":{"desc":"Conjunto de Niño","price":33.35},"0899428":{"desc":"Diadema","price":9.25},"1199428":{"desc":"Pelele","price":20.25},"1299428":{"desc":"Jesusito con Capota","price":53.35},"1399428":{"desc":"Jesusito sin Capota","price":50.75},"2599428":{"desc":"Vestido","price":51.7},"1299429":{"desc":"Jesusito con Capota","price":47.15},"1399429":{"desc":"Jesusito sin Capota","price":44.85},"2599429":{"desc":"Vestido","price":51.7},"0899430":{"desc":"Diadema","price":9.25},"1299430":{"desc":"Jesusito con Capota","price":39.7},"1399430":{"desc":"Jesusito sin Capota","price":36.95},"2599430":{"desc":"Vestido","price":38.5},"4399430":{"desc":"Conjunto de Niño","price":31.35},"0899431":{"desc":"Diadema","price":9.25},"1299431":{"desc":"Jesusito con Capota","price":40.45},"1399431":{"desc":"Jesusito sin Capota","price":37.95},"2599431":{"desc":"Vestido","price":39.8},"3099431":{"desc":"Conjunto de Niño","price":24.65},"0809432":{"desc":"Diadema","price":9.25},"1209432":{"desc":"Jesusito con Capota","price":39.15},"1309432":{"desc":"Jesusito sin Capota","price":36.95},"2509432":{"desc":"Vestido","price":38.95},"4309432":{"desc":"Conjunto de Niño","price":29.75},"0899432":{"desc":"Diadema","price":9.25},"1299432":{"desc":"Jesusito con Capota","price":41.95},"1399432":{"desc":"Jesusito sin Capota","price":39.25},"2599432":{"desc":"Vestido","price":41.65},"4399432":{"desc":"Conjunto de Niño","price":30.75},"0899433":{"desc":"Diadema","price":9.25},"1299433":{"desc":"Jesusito con Capota","price":46.75},"1399433":{"desc":"Jesusito sin Capota","price":45.25},"2599433":{"desc":"Vestido","price":49.25},"0899434":{"desc":"Diadema","price":9.25},"1199434":{"desc":"Pelele","price":22.65},"1299434":{"desc":"Jesusito con Capota","price":44.45},"1399434":{"desc":"Jesusito sin Capota","price":39.15},"2599434":{"desc":"Vestido","price":37.7},"0805435":{"desc":"Diadema","price":9.25},"1205435":{"desc":"Jesusito con Capota","price":41.5},"1305435":{"desc":"Jesusito sin Capota","price":39.35},"2505435":{"desc":"Vestido","price":43.1},"0899435":{"desc":"Diadema","price":9.25},"1208435":{"desc":"Jesusito con Capota","price":41.5},"1308435":{"desc":"Jesusito sin Capota","price":39.35},"2508435":{"desc":"Vestido","price":43.1},"220257":{"desc":"Abrigo Rojo","price":40.75},"220357":{"desc":"Abrigo Azul Marino","price":40.75},"220657":{"desc":"Abrigo Camel","price":40.75},"220158":{"desc":"Abrigo Rosa","price":37.65},"220258":{"desc":"Abrigo Rojo","price":37.65},"220358":{"desc":"Abrigo Azul Marino","price":37.65},"220658":{"desc":"Abrigo Camel","price":37.65},"220159":{"desc":"Abrigo Rosa","price":39.35},"220259":{"desc":"Abrigo Rojo","price":39.35},"220359":{"desc":"Abrigo Azul Marino","price":39.35},"220659":{"desc":"Abrigo Camel","price":39.35},"220160":{"desc":"Abrigo Rosa","price":37.75},"220260":{"desc":"Abrigo Rojo","price":37.75},"220360":{"desc":"Abrigo Azul Marino","price":37.75},"220660":{"desc":"Abrigo Camel","price":37.75}};

    // Tallajes por tipo
    const SIZES_BABY = ["3M","6M","9M","18M","2A","3A","4A"]; // 12/13/30/31
    const SIZES_KIDS = ["12M","18M","2A","3A","4A","5A","6A","8A","10A","12A"]; // 25/22/43
    const SIZES_U = ["TU"]; // 08

    const state = { lines: [], expanded: {} };
    const $ = (sel)=>document.querySelector(sel);

    const now = new Date();
    const ORDER_DATE = new Intl.DateTimeFormat("es-ES", { day:"2-digit", month:"2-digit", year:"numeric" }).format(now);

    function eur(n){
      const v = Number(n||0);
      try{
        return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v);
      }catch(e){
        return (Math.round(v*100)/100).toFixed(2).replace('.', ',') + " €";
      }
    }
    function n2(v){ return Math.max(0, Math.floor(Number(v||0))); }

    function prefix2(ref){
      const r = String(ref||"").trim();
      return r.length>=2 ? r.slice(0,2) : "";
    }

    function sizesForRef(ref){
      const p = prefix2(ref);
      if(p==="08") return SIZES_U;
      if(p==="12" || p==="13" || p==="30" || p==="31") return SIZES_BABY;
      if(p==="25" || p==="22" || p==="43") return SIZES_KIDS;
      return SIZES_KIDS;
    }

    function ensureSizes(line, ref){
      const wanted = sizesForRef(ref);
      line.sizes = wanted.slice();
      const nextQty = {};
      line.sizes.forEach(s => nextQty[s] = n2(line.qty?.[s] ?? 0));
      line.qty = nextQty;
    }

    function defaultLine(){
      const id = (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()));
      const line = { ref:"", desc:"", price:0, qty:{}, sizes:SIZES_KIDS.slice(), id };
      ensureSizes(line, "25");
      return line;
    }

    function getInfoByRef(ref){
      const it = window.PRICE_MAP[String(ref||"").trim()];
      if(!it) return {desc:"", price:0};
      return {desc: it.desc || "", price: Number(it.price||0)};
    }

    function lineUnits(line){
      return (line.sizes||[]).reduce((a,s)=>a + n2(line.qty?.[s]), 0);
    }
    function lineSubtotal(line){
      return lineUnits(line) * Number(line.price||0);
    }
    function totalUnits(){
      return state.lines.reduce((a,l)=>a+lineUnits(l),0);
    }
    function totalEur(){
      return state.lines.reduce((a,l)=>a+lineSubtotal(l),0);
    }

    function imgForRef(ref){
      const r = String(ref||"").trim();
      if(!r) return "images/placeholder.jpg";
      return `images/${r}.jpg`;
    }

    // ===== Visor de imagen =====
    function openImageModal({src, ref, desc}){
      const modal = document.getElementById("imgModal");
      document.getElementById("imgModalPic").src = src;
      document.getElementById("imgModalRef").textContent = ref ? `REF ${ref}` : "";
      document.getElementById("imgModalDesc").textContent = desc || "";
      modal.setAttribute("aria-hidden","false");
    }
    function closeImageModal(){
      const modal = document.getElementById("imgModal");
      modal.setAttribute("aria-hidden","true");
      document.getElementById("imgModalPic").src = "";
    }
    document.addEventListener("click", (e)=>{
      if(e.target && e.target.dataset && e.target.dataset.close === "1"){
        closeImageModal();
      }
    });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeImageModal(); });

    // ===== Acciones GLOBAL (para + y - sin bloqueos) =====
    function findLineById(lineId){ return state.lines.find(l => l.id === lineId); }

    window.incQty = function(lineId, size){
      const L = findLineById(lineId);
      if(!L) return;
      L.qty[size] = n2(L.qty?.[size]) + 1;
      render();
    };

    window.decQty = function(lineId, size){
      const L = findLineById(lineId);
      if(!L) return;
      L.qty[size] = Math.max(0, n2(L.qty?.[size]) - 1);
      render();
    };

    window.setQty = function(lineId, size, val){
      const L = findLineById(lineId);
      if(!L) return;
      L.qty[size] = n2(val);
      render();
    };

    window.delLine = function(lineId){
      const idx = state.lines.findIndex(l => l.id === lineId);
      if(idx === -1) return;
      delete state.expanded[lineId];
      state.lines.splice(idx, 1);
      if(!state.lines.length){
        const l = defaultLine();
        state.lines.push(l);
        state.expanded[l.id] = true;
      }
      render();
    };

    window.zoomLine = function(lineId){
      const L = findLineById(lineId);
      if(!L) return;
      openImageModal({ src: imgForRef(L.ref), ref: L.ref, desc: L.desc });
    };

    // ===== Render =====
    function render(){
      const linesWrap = $("#lines");
      linesWrap.innerHTML = "";

      state.lines.forEach((line)=>{
        const isOpen = !!state.expanded[line.id];
        const sizes = line.sizes || SIZES_KIDS;

        const card = document.createElement("div");
        card.className = "line";

        card.innerHTML = `
          <div class="lineTop">
            <button class="pimgBtn" type="button"
              onclick="zoomLine('${line.id}')"
              title="Ver imagen ampliada">
              <img src="${imgForRef(line.ref)}" alt="" onerror="this.src='images/placeholder.jpg'">
            </button>

            <div class="meta">
              <div class="r1">
                <div class="field suggest-wrap">
                  <label>Referencia</label>
                  <input type="text" inputmode="numeric" placeholder="Ej.: 1299426"
                         value="${line.ref}" class="refInput" data-lineid="${line.id}">
                  <div class="suggest" id="suggest_${line.id}"></div>
                </div>

                <div class="field">
                  <label>Descripción</label>
                  <input type="text" placeholder="(automática)"
                         value="${line.desc}" class="descInput" data-lineid="${line.id}">
                </div>

                <div class="field" style="max-width:200px">
                  <label>Precio (€/ud)</label>
                  <input type="number" step="0.01" value="${Number(line.price||0)}"
                         class="priceInput" data-lineid="${line.id}">
                </div>

                <button class="btn small" type="button" onclick="delLine('${line.id}')">Eliminar</button>
              </div>

              <div class="r2">
                <b>Subtotal:</b> <span class="money">${eur(lineSubtotal(line))}</span>
                <span class="muted"> · Unidades: ${lineUnits(line)}</span>
              </div>

              <details class="sizesDetails" ${isOpen ? "open" : ""} data-id="${line.id}">
                <summary class="sizesSummary">
                  <span class="sumLeft">
                    <span class="badge">Tallas</span>
                    <span class="muted">(${prefix2(line.ref)||"—"}) · Pulsa para ${isOpen ? "plegar" : "desplegar"}</span>
                  </span>
                  <span class="muted">${isOpen ? "▲" : "▼"}</span>
                </summary>

                <div class="sizesBody">
                  <div class="sizes">
                    ${sizes.map(s=>`
                      <div class="sz">
                        <span class="t">${s}</span>
                        <span class="step" onclick="event.stopPropagation()">
                          <button type="button"
                            onclick="decQty('${line.id}','${s}');event.stopPropagation();"
                            aria-label="Disminuir">−</button>

                          <input value="${n2(line.qty?.[s])}"
                            inputmode="numeric"
                            onclick="event.stopPropagation()"
                            onchange="setQty('${line.id}','${s}', this.value)"
                            aria-label="Cantidad ${s}">

                          <button type="button"
                            onclick="incQty('${line.id}','${s}');event.stopPropagation();"
                            aria-label="Aumentar">+</button>
                        </span>
                      </div>
                    `).join("")}
                  </div>
                </div>
              </details>
            </div>
          </div>
        `;

        linesWrap.appendChild(card);

        // Guardar estado de abierto/cerrado
        const det = card.querySelector("details.sizesDetails");
        if(det){
          det.addEventListener("toggle", () => {
            state.expanded[line.id] = det.open;
          });
        }

        // Autocomplete por línea
        const refInp = card.querySelector(".refInput");
        const sugBox = card.querySelector(`#suggest_${line.id}`);
        setupAutocomplete(refInp, sugBox, line.id);
      });

      $("#totalUds").textContent = totalUnits();
      $("#totalUds2").textContent = totalUnits();
      $("#totalEur").textContent = eur(totalEur());
      $("#totalEur2").textContent = eur(totalEur());

      renderSummary();
      renderEmail();
    }

    function renderSummary(){
      const wrap = $("#summaryWrap");
      const rows = state.lines
        .filter(l=>String(l.ref||"").trim() && lineUnits(l)>0)
        .map(l=>{
          const sizes = l.sizes || [];
          const tallas = sizes.filter(s=>n2(l.qty?.[s])>0).map(s=>({s, q:n2(l.qty?.[s])}));
          return { ref:l.ref, desc:l.desc, price:l.price, uds:lineUnits(l), sub:lineSubtotal(l), tallas };
        });

      if(!rows.length){
        wrap.innerHTML = `<p class="hint">Aún no hay líneas con unidades. Añade una referencia y asigna cantidades por talla.</p>`;
        return;
      }

      wrap.innerHTML = `
        <label>Resumen (Fecha del pedido: <b>${ORDER_DATE}</b>)</label>
        <div class="tableScroll" role="region" aria-label="Resumen del pedido" tabindex="0">
          <table>
            <thead>
              <tr>
                <th class="nowrap">Ref.</th>
                <th>Descripción</th>
                <th class="nowrap right">€/ud</th>
                <th>Tallas</th>
                <th class="nowrap right">Uds</th>
                <th class="nowrap right">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td class="nowrap"><b>${r.ref}</b></td>
                  <td>${r.desc || '<span class="muted">(sin descripción)</span>'}</td>
                  <td class="nowrap right">${eur(r.price)}</td>
                  <td>
                    <div class="chips">
                      ${r.tallas.map(t=>`<span class="chip">${t.s}: ${t.q}</span>`).join("")}
                    </div>
                  </td>
                  <td class="nowrap right"><b>${r.uds}</b></td>
                  <td class="nowrap right"><b>${eur(r.sub)}</b></td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <span class="pill"><span class="muted">Total unidades:</span> <b>${totalUnits()}</b></span>
          <span class="pill"><span class="muted">Total:</span> <b>${eur(totalEur())}</b></span>
        </div>
      `;
    }

    // Email neutro + fecha (SIN FIRMA)
    function renderEmail(){
      const rows = state.lines
        .filter(l=>String(l.ref||"").trim() && lineUnits(l)>0)
        .map(l=>{
          const sizes = l.sizes || [];
          const tallas = sizes.filter(s=>n2(l.qty?.[s])>0).map(s=>`${s}: ${n2(l.qty?.[s])}`).join(" · ");
          return { ref:l.ref, desc:l.desc, price:l.price, uds:lineUnits(l), sub:lineSubtotal(l), tallas };
        });

      const subject = `Pedido · Abuela Tata · Invierno AW 26/27 · ${ORDER_DATE}`;
      let body = "";
      body += `Hola,\n\n`;
      body += `Pedido Invierno AW 26/27\n`;
      body += `Fecha: ${ORDER_DATE}\n\n`;

      if(!rows.length){
        body += `— Aún no hay unidades en el pedido.\n`;
      } else {
        rows.forEach(r=>{
          body += `REF ${r.ref}\n`;
          body += `Descripción: ${r.desc}\n`;
          body += `Precio/unidad: ${eur(r.price)}\n`;
          body += `Tallas: ${r.tallas}\n`;
          body += `Subtotal (${r.uds} uds): ${eur(r.sub)}\n`;
          body += `----------------------------------------\n`;
        });
        body += `TOTAL UNIDADES: ${totalUnits()}\n`;
        body += `TOTAL: ${eur(totalEur())}\n`;
      }

      $("#emailBox").value = body;
      $("#mailtoBtn").dataset.subject = subject;
    }

    // Autocomplete
    function setupAutocomplete(input, box, lineId){
      const all = Object.entries(window.PRICE_MAP).map(([ref,v])=>({
        ref:String(ref),
        desc:String(v.desc||""),
        price:Number(v.price||0)
      }));

      let active = -1;
      let current = [];

      function open(list){
        if(!list.length){ box.style.display="none"; box.innerHTML=""; return; }
        current = list;
        active = 0;
        box.innerHTML = list.map((it,i)=>`
          <div class="suggest-item ${i===0?'active':''}" data-i="${i}">
            <div>
              <div class="ref">${it.ref}</div>
              <div class="desc">${it.desc}</div>
            </div>
            <div class="price">${eur(it.price)}</div>
          </div>
        `).join("");
        box.style.display="block";
      }

      function setActive(i){
        active = i;
        [...box.querySelectorAll(".suggest-item")].forEach((el,idx)=>{
          el.classList.toggle("active", idx===active);
        });
      }

      function apply(it){
        const L = findLineById(lineId);
        if(!L) return;
        L.ref = it.ref;
        L.desc = it.desc;
        L.price = it.price;
        ensureSizes(L, it.ref);
        state.expanded[L.id] = true;
        render();
      }

      input.addEventListener("input", ()=>{
        const v = String(input.value||"").trim();
        if(v.length < 1){ box.style.display="none"; return; }
        let res = all.filter(x=>x.ref.startsWith(v));
        if(!res.length) res = all.filter(x=>x.ref.includes(v));
        res = res.slice(0,12);
        open(res);
      });

      input.addEventListener("keydown", (e)=>{
        if(box.style.display!=="block") return;
        if(e.key==="ArrowDown"){ e.preventDefault(); setActive(Math.min(active+1, current.length-1)); }
        if(e.key==="ArrowUp"){ e.preventDefault(); setActive(Math.max(active-1, 0)); }
        if(e.key==="Enter"){
          if(current[active]){ e.preventDefault(); apply(current[active]); }
        }
        if(e.key==="Escape"){ box.style.display="none"; }
      });

      box.addEventListener("mousedown", (e)=>{
        const item = e.target.closest(".suggest-item");
        if(!item) return;
        e.preventDefault();
        const i = Number(item.dataset.i);
        if(current[i]) apply(current[i]);
      });

      input.addEventListener("change", ()=>{
        const v = String(input.value||"").trim();
        const L = findLineById(lineId);
        if(!L) return;
        L.ref = v;
        ensureSizes(L, v);
        const it = getInfoByRef(v);
        if(it.desc){ L.desc = it.desc; L.price = it.price; }
        state.expanded[L.id] = true;
        render();
      });

      document.addEventListener("click", (e)=>{
        if(e.target===input) return;
        if(box.contains(e.target)) return;
        box.style.display="none";
      });
    }

    // PDF con imagen y fecha
    function loadImageAsDataURL(url){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
          try{
            const canvas = document.createElement("canvas");
            canvas.width = img.naturalWidth || 800;
            canvas.height = img.naturalHeight || 800;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img,0,0);
            resolve(canvas.toDataURL("image/jpeg", 0.92));
          }catch(e){ resolve(null); }
        };
        img.onerror = ()=> resolve(null);
        img.src = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      });
    }

    async function makePDF(){
      const { jsPDF } = (window.jspdf || {});
      if(!jsPDF){
        alert("La librería del PDF aún no ha cargado. Recarga y vuelve a intentarlo.");
        return;
      }

      const rows = state.lines
        .filter(l=>String(l.ref||"").trim() && lineUnits(l)>0)
        .map(l=>{
          const sizes = l.sizes || [];
          const tallas = sizes.filter(s=>n2(l.qty?.[s])>0).map(s=>`${s}: ${n2(l.qty?.[s])}`);
          return { ref:l.ref, desc:l.desc, price:l.price, uds:lineUnits(l), sub:lineSubtotal(l), tallas };
        });

      const doc = new jsPDF({ unit:"pt", format:"a4" });
      const W = doc.internal.pageSize.getWidth();
      const H = doc.internal.pageSize.getHeight();

      let y = 44;
      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("Pedido · Abuela Tata · Invierno AW 26/27", 40, y);

      y += 18;
      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.text(`Fecha: ${ORDER_DATE}   ·   Total unidades: ${totalUnits()}   ·   Total: ${eur(totalEur())}`, 40, y);

      y += 26;

      if(!rows.length){
        doc.text("No hay unidades en el pedido.", 40, y);
        doc.save("pedido_aw26-27.pdf");
        return;
      }

      doc.setFont("helvetica","bold");
      doc.setFontSize(10);
      doc.text("IMAGEN", 40, y);
      doc.text("REF", 125, y);
      doc.text("DESCRIPCIÓN", 190, y);
      doc.text("€/UD", W-210, y, { align:"right" });
      doc.text("UDS", W-150, y, { align:"right" });
      doc.text("SUBTOTAL", W-40, y, { align:"right" });

      y += 10;
      doc.setLineWidth(0.5);
      doc.line(40, y, W-40, y);
      y += 16;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);

      for(const r of rows){
        if(y > H - 110){
          doc.addPage();
          y = 52;
        }

        const imgX = 40, imgY = y - 6, boxW = 70, boxH = 70;
        doc.setDrawColor(220);
        doc.rect(imgX, imgY, boxW, boxH);

        const dataUrl = await loadImageAsDataURL(`images/${r.ref}.jpg`);
        if(dataUrl){
          try{ doc.addImage(dataUrl, "JPEG", imgX, imgY, boxW, boxH); }catch(e){}
        }

        doc.setFont("helvetica","bold");
        doc.text(String(r.ref), 125, y);

        doc.setFont("helvetica","normal");
        doc.text(String(r.desc||""), 190, y, { maxWidth: (W - 40) - 190 - 240 });

        doc.text(eur(r.price), W-210, y, { align:"right" });
        doc.text(String(r.uds), W-150, y, { align:"right" });
        doc.text(eur(r.sub), W-40, y, { align:"right" });

        y += 14;
        doc.setFontSize(9);
        doc.setTextColor(80);
        doc.text(r.tallas.join(" · "), 125, y, { maxWidth: W - 165 });
        doc.setTextColor(0);
        doc.setFontSize(10);

        y += 22;
        doc.setDrawColor(230);
        doc.line(40, y, W-40, y);
        y += 14;
      }

      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.text(`FECHA: ${ORDER_DATE}`, 40, H-54);
      doc.text(`TOTAL: ${eur(totalEur())}`, W-40, H-54, { align:"right" });

      doc.save(`pedido_aw26-27_${ORDER_DATE.replaceAll("/","-")}.pdf`);
    }

    function addLine(){
      const l = defaultLine();
      state.lines.push(l);
      state.expanded[l.id] = true;
      render();
    }
    function clearAll(){
      state.lines = [defaultLine()];
      state.expanded = {};
      state.expanded[state.lines[0].id] = true;
      render();
    }

    function copyEmail(){
      const t = $("#emailBox");
      t.focus();
      t.select();
      t.setSelectionRange(0, 999999);
      try{ document.execCommand("copy"); }catch(e){}
    }

    function openMailto(){
      const subject = $("#mailtoBtn").dataset.subject || "Pedido";
      const body = $("#emailBox").value || "";
      window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      $("#orderDateLabel").textContent = `Fecha del pedido: ${ORDER_DATE}`;
      $("#orderDatePill").textContent = ORDER_DATE;
      $("#orderDatePill2").textContent = ORDER_DATE;

      $("#addLineBtn").addEventListener("click", addLine);
      $("#addLineBtn2").addEventListener("click", addLine);

      $("#copyEmailBtn").addEventListener("click", copyEmail);
      $("#mailtoBtn").addEventListener("click", openMailto);

      $("#pdfBtn").addEventListener("click", makePDF);
      $("#pdfBtn2").addEventListener("click", makePDF);

      $("#clearBtn").addEventListener("click", clearAll);

      const first = defaultLine();
      state.lines = [first];
      state.expanded[first.id] = true;
      render();
    });
  })();
  </script>
</body>
</html>
