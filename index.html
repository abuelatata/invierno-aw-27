<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Abuela Tata ¬∑ Invierno AW 26/27 ¬∑ Pedidos</title>

  <!-- jsPDF para PDF en el navegador -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f8f7;
      --card:#ffffff;
      --ink:#102a2a;
      --muted:#5c6b6b;
      --brand:#8fcfc5;
      --brand2:#6bbeb1;
      --line:rgba(16,42,42,.12);
      --shadow:0 8px 30px rgba(16,42,42,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg, #ffffff 0%, var(--bg) 32%, var(--bg) 100%);
      -webkit-font-smoothing:antialiased;
      padding-bottom:118px;
    }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      max-width:1100px;
      margin:0 auto;
      padding:14px 14px 12px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center; min-width:240px;}
    .badge{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%);
      box-shadow: 0 10px 22px rgba(107,190,177,.25);
    }
    .brand h1{font-size:15px; line-height:1.15; margin:0; letter-spacing:.2px;}
    .brand small{display:block; color:var(--muted); font-weight:500; margin-top:2px;}
    .search{
      flex:1; min-width:240px;
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
    }
    .search input{
      width:min(520px, 100%);
      padding:12px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-size:14px;
    }
    .search input:focus{
      border-color:rgba(143,207,197,.65);
      box-shadow:0 0 0 4px rgba(143,207,197,.18);
    }

    /* --- Banderas --- */
    .langFlags{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex:0 0 auto;
    }
    .flagBtn{
      width:40px;
      height:40px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:20px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 6px 16px rgba(16,42,42,.08);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .flagBtn:active{ transform: scale(.98); }
    .flagBtn.active{
      border-color: rgba(143,207,197,.85);
      box-shadow:0 0 0 4px rgba(143,207,197,.18);
    }

    main{max-width:1100px; margin:0 auto; padding:14px;}

    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin:10px 2px 14px;
      color:var(--muted);
      font-size:13px;
    }
    .pill{
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow:0 4px 14px rgba(16,42,42,.06);
    }

    .section{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 26px rgba(16,42,42,.07);
      padding:12px;
      margin:10px 0 14px;
    }
    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:2px 2px 10px;
    }
    .sectionTitle strong{font-size:14px;}
    .hint{color:var(--muted); font-size:12px;}

    .formGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width: 900px){
      .formGrid{grid-template-columns: repeat(3, 1fr);}
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    .field input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      font-size:13px;
      background:#fff;
    }
    .field input:focus{
      border-color:rgba(143,207,197,.65);
      box-shadow:0 0 0 4px rgba(143,207,197,.18);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }
    .card{
      grid-column: span 12;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    @media (min-width: 820px){ .card{ grid-column: span 6; } }
    @media (min-width: 1080px){ .card{ grid-column: span 4; } }

    .cardTop{
      display:flex;
      gap:12px;
      padding:12px;
      border-bottom:1px solid var(--line);
    }

    .thumb{
      width:88px; height:88px;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(143,207,197,.25), rgba(107,190,177,.18));
      border:1px solid rgba(16,42,42,.10);
      overflow:hidden;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: zoom-in;
      position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .thumb .ph{
      font-weight:800; color:rgba(16,42,42,.55);
      letter-spacing:.5px; font-size:13px;
      text-align:center; padding:10px;
    }

    .info{min-width:0; flex:1; display:flex; flex-direction:column; gap:6px; padding-top:2px;}
    .row1{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .ref{font-weight:800; font-size:14px; letter-spacing:.3px;}
    .name{font-size:13px; color:var(--muted); line-height:1.25; margin-top:2px; max-height:2.5em; overflow:hidden;}
    .price{
      font-weight:900; color:var(--ink); font-size:14px;
      background:rgba(143,207,197,.22);
      border:1px solid rgba(143,207,197,.35);
      padding:6px 10px; border-radius:999px; white-space:nowrap;
    }

    .sizes{padding:12px; display:flex; flex-direction:column; gap:10px;}
    .sizesHeader{display:flex; align-items:center; justify-content:space-between; gap:10px; color:var(--muted); font-size:12px;}
    .sizesGrid{display:grid; grid-template-columns: 1fr; gap:10px;}
    .sizeLine{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
    }
    .sizeTag{font-weight:800; font-size:13px; letter-spacing:.2px; min-width:54px;}
    .stepper{display:flex; align-items:center; gap:10px;}
    .btn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(16,42,42,.14);
      background:linear-gradient(180deg, #fff 0%, #f7fbfa 100%);
      box-shadow: 0 6px 16px rgba(16,42,42,.08);
      font-size:20px; font-weight:900; color:var(--ink);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.98); }
    .qty{
      width:54px; height:44px;
      border-radius:14px;
      border:1px solid rgba(16,42,42,.14);
      text-align:center;
      font-weight:900; font-size:14px;
      outline:none; background:#fff;
    }

    .lineTotal{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px 12px;
      border-top:1px dashed rgba(16,42,42,.14);
      color:var(--muted); font-size:13px;
    }
    .lineTotal strong{ color:var(--ink); }

    .bottomBar{
      position:fixed; left:0; right:0; bottom:0;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      z-index:60;
    }
    .bottomInner{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .totals{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color:var(--muted); font-size:13px;
    }
    .totals .big{
      color:var(--ink);
      font-weight:1000;
      font-size:16px;
      letter-spacing:.2px;
      background:rgba(143,207,197,.22);
      border:1px solid rgba(143,207,197,.35);
      padding:8px 12px;
      border-radius:999px;
      white-space:nowrap;
    }

    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .primary{
      border:none;
      background:linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%);
      color:#fff;
      font-weight:900;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(107,190,177,.25);
      -webkit-tap-highlight-color: transparent;
    }
    .secondary{
      border:1px solid rgba(16,42,42,.14);
      background:#fff;
      color:var(--ink);
      font-weight:900;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .noteErr{
      margin:14px 0 0;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(180,0,0,.25);
      background:rgba(255,0,0,.06);
      color:#7a1111;
      font-size:13px;
      display:none;
    }

    /* Lightbox imagen grande */
    .lightbox{
      position:fixed; inset:0;
      background:rgba(16,42,42,.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:90;
      padding:18px;
    }
    .lightboxInner{
      width:min(980px, 100%);
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 20px 70px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.25);
    }
    .lightboxHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.92);
    }
    .lightboxHead strong{font-size:13px;}
    .lightboxImg{
      width:100%;
      height:auto;
      display:block;
      background:#fff;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="badge" aria-hidden="true"></div>
        <div>
          <h1 id="ui_title">Abuela Tata ¬∑ Invierno AW 26/27</h1>
          <small id="ui_subtitle">Pedidos ¬∑ Selector de tallas (m√≥vil pro)</small>
        </div>
      </div>

      <div class="search">
        <input id="q" type="search" placeholder="Buscar por referencia o nombre‚Ä¶" autocomplete="off" />
        <div id="langFlags" class="langFlags" aria-label="Language">
          <button type="button" class="flagBtn" data-lang="es" title="Espa√±ol" aria-label="Espa√±ol">üá™üá∏</button>
          <button type="button" class="flagBtn" data-lang="en" title="English" aria-label="English">üá¨üáß</button>
          <button type="button" class="flagBtn" data-lang="pt" title="Portugu√™s" aria-label="Portugu√™s">üáµüáπ</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="section">
      <div class="sectionTitle">
        <strong id="ui_clientTitle">Datos del cliente</strong>
        <span class="hint" id="ui_clientHint">Estos datos se meten en el email del pedido</span>
      </div>

      <div class="formGrid">
        <div class="field">
          <label id="ui_lbl_name">Nombre cliente *</label>
          <input id="c_name" type="text" placeholder="Ej: Boutique Naya" />
        </div>
        <div class="field">
          <label id="ui_lbl_vat">CIF / NIF *</label>
          <input id="c_vat" type="text" placeholder="Ej: B12345678" />
        </div>
        <div class="field">
          <label id="ui_lbl_email">Email cliente *</label>
          <input id="c_email" type="email" placeholder="Ej: compras@tienda.com" />
        </div>
        <div class="field">
          <label id="ui_lbl_cp">C√≥digo postal *</label>
          <input id="c_cp" type="text" inputmode="numeric" placeholder="Ej: 41620" />
        </div>
        <div class="field">
          <label id="ui_lbl_city">Localidad *</label>
          <input id="c_city" type="text" placeholder="Ej: Marchena" />
        </div>
        <div class="field">
          <label id="ui_lbl_notes">Observaciones (opcional)</label>
          <input id="c_notes" type="text" placeholder="Ej: Entrega urgente / Comentarios‚Ä¶" />
        </div>
      </div>
    </div>

    <div class="section" id="offlineBox" style="display:none">
      <div class="sectionTitle">
        <strong id="ui_offlineTitle">Modo escritorio (offline)</strong>
        <span class="hint" id="ui_offlineHint">Si abriste el archivo desde el PC, carga la tarifa aqu√≠</span>
      </div>

      <div class="formGrid" style="grid-template-columns:1fr;">
        <div class="field">
          <label id="ui_offlineLabel">Cargar tarifa.json desde tu ordenador</label>
          <input id="tarifaFile" type="file" accept=".json,application/json" />
        </div>
      </div>
    </div>

    <div class="meta">
      <div class="pill" id="ui_pill_products">üì¶ Productos: <strong id="count">0</strong></div>
      <div class="pill" id="ui_pill_lines">üßæ L√≠neas con cantidades: <strong id="lines">0</strong></div>
    </div>

    <div id="err" class="noteErr"></div>
    <div class="grid" id="grid"></div>
  </main>

  <div class="bottomBar">
    <div class="bottomInner">
      <div class="totals">
        <span id="ui_unitsLabel">Unidades: <strong id="u">0</strong></span>
        <span class="big" id="ui_totalLabel">Total: <span id="t">0,00</span> ‚Ç¨</span>
      </div>
      <div class="actions">
        <button class="secondary" id="btnClear" type="button">Vaciar</button>
        <button class="secondary" id="btnPDF" type="button">üìÑ PDF</button>
        <button class="primary" id="btnEmail" type="button">‚úâÔ∏è Enviar pedido</button>
      </div>
    </div>
  </div>

  <!-- Lightbox imagen grande -->
  <div class="lightbox" id="lb">
    <div class="lightboxInner">
      <div class="lightboxHead">
        <strong id="lbTitle">Modelo</strong>
        <button class="secondary" id="lbClose" type="button">Cerrar</button>
      </div>
      <img id="lbImg" class="lightboxImg" alt="Imagen modelo" />
    </div>
  </div>

  <script>
    // =============================
    // i18n (ES / EN / PT)
    // =============================
    let currentLang = "es";

    const translations = {
      es: {
        title: "Abuela Tata ¬∑ Invierno AW 26/27",
        subtitle: "Pedidos ¬∑ Selector de tallas (m√≥vil pro)",
        search: "Buscar por referencia o nombre‚Ä¶",

        clientTitle: "Datos del cliente",
        clientHint: "Estos datos se meten en el email del pedido",
        lbl_name: "Nombre cliente *",
        lbl_vat: "CIF / NIF *",
        lbl_email: "Email cliente *",
        lbl_cp: "C√≥digo postal *",
        lbl_city: "Localidad *",
        lbl_notes: "Observaciones (opcional)",
        ph_name: "Ej: Boutique Naya",
        ph_vat: "Ej: B12345678",
        ph_email: "Ej: compras@tienda.com",
        ph_cp: "Ej: 41620",
        ph_city: "Ej: Marchena",
        ph_notes: "Ej: Entrega urgente / Comentarios‚Ä¶",

        offlineTitle: "Modo escritorio (offline)",
        offlineHint: "Si abriste el archivo desde el PC, carga la tarifa aqu√≠",
        offlineLabel: "Cargar tarifa.json desde tu ordenador",

        pill_products: "üì¶ Productos:",
        pill_lines: "üßæ L√≠neas con cantidades:",
        unitsLabel: "Unidades:",
        totalLabel: "Total:",

        btnClear: "Vaciar",
        btnPDF: "üìÑ PDF",
        btnEmail: "‚úâÔ∏è Enviar pedido",
        lbClose: "Cerrar",

        missingData: "Faltan datos del cliente:",
        noQty: "No hay cantidades seleccionadas todav√≠a.",

        // Etiquetas
        type: "Tipo",
        family: "Familia",
        sizes: "Tallas",
        lineSubtotal: "Subtotal l√≠nea",

        // Email/PDF
        orderSubjectPrefix: "PEDIDO AW26/27",
        appGenerated: "PEDIDO (generado desde la app)",
        dateTime: "Fecha y hora",
        clientDataBlock: "DATOS DEL CLIENTE",
        orderDetails: "DETALLE DEL PEDIDO",
        price: "Precio",
        subtotal: "Subtotal",
        units: "Uds",
        totalUnits: "TOTAL UNIDADES",
        totalEUR: "TOTAL ‚Ç¨",
        thanks: "Muchas gracias",
        confirm: "Esperamos confirmaci√≥n de pedido",
        pdfTitle: "ABUELA TATA ¬∑ INVIERNO AW 26/27",
        obs: "Obs",
        noPhoto: "Sin foto"
      },

      en: {
        title: "Abuela Tata ¬∑ Winter AW 26/27",
        subtitle: "Orders ¬∑ Size selector (mobile pro)",
        search: "Search by reference or name‚Ä¶",

        clientTitle: "Client details",
        clientHint: "These details will appear in the order email",
        lbl_name: "Client name *",
        lbl_vat: "VAT / Tax ID *",
        lbl_email: "Client email *",
        lbl_cp: "Postcode *",
        lbl_city: "City *",
        lbl_notes: "Notes (optional)",
        ph_name: "e.g. Boutique Naya",
        ph_vat: "e.g. B12345678",
        ph_email: "e.g. buying@shop.com",
        ph_cp: "e.g. 41620",
        ph_city: "e.g. Marchena",
        ph_notes: "e.g. Urgent delivery / Comments‚Ä¶",

        offlineTitle: "Desktop mode (offline)",
        offlineHint: "If you opened the file from your PC, load the price list here",
        offlineLabel: "Load tarifa.json from your computer",

        pill_products: "üì¶ Products:",
        pill_lines: "üßæ Lines with quantities:",
        unitsLabel: "Units:",
        totalLabel: "Total:",

        btnClear: "Clear",
        btnPDF: "üìÑ PDF",
        btnEmail: "‚úâÔ∏è Send order",
        lbClose: "Close",

        missingData: "Missing client information:",
        noQty: "No quantities selected yet.",

        // Labels
        type: "Type",
        family: "Family",
        sizes: "Sizes",
        lineSubtotal: "Line subtotal",

        // Email/PDF
        orderSubjectPrefix: "ORDER AW26/27",
        appGenerated: "ORDER (generated from the app)",
        dateTime: "Date & time",
        clientDataBlock: "CLIENT DETAILS",
        orderDetails: "ORDER DETAILS",
        price: "Price",
        subtotal: "Subtotal",
        units: "Units",
        totalUnits: "TOTAL UNITS",
        totalEUR: "TOTAL ‚Ç¨",
        thanks: "Thank you",
        confirm: "Please confirm the order",
        pdfTitle: "ABUELA TATA ¬∑ WINTER AW 26/27",
        obs: "Notes",
        noPhoto: "No photo"
      },

      pt: {
        title: "Abuela Tata ¬∑ Inverno AW 26/27",
        subtitle: "Pedidos ¬∑ Seletor de tamanhos (mobile pro)",
        search: "Pesquisar por refer√™ncia ou nome‚Ä¶",

        clientTitle: "Dados do cliente",
        clientHint: "Estes dados aparecer√£o no email do pedido",
        lbl_name: "Nome do cliente *",
        lbl_vat: "NIF / ID Fiscal *",
        lbl_email: "Email do cliente *",
        lbl_cp: "C√≥digo postal *",
        lbl_city: "Localidade *",
        lbl_notes: "Observa√ß√µes (opcional)",
        ph_name: "Ex.: Boutique Naya",
        ph_vat: "Ex.: B12345678",
        ph_email: "Ex.: compras@loja.com",
        ph_cp: "Ex.: 41620",
        ph_city: "Ex.: Marchena",
        ph_notes: "Ex.: Entrega urgente / Coment√°rios‚Ä¶",

        offlineTitle: "Modo desktop (offline)",
        offlineHint: "Se abriu o ficheiro no PC, carregue a lista aqui",
        offlineLabel: "Carregar tarifa.json do seu computador",

        pill_products: "üì¶ Produtos:",
        pill_lines: "üßæ Linhas com quantidades:",
        unitsLabel: "Unidades:",
        totalLabel: "Total:",

        btnClear: "Limpar",
        btnPDF: "üìÑ PDF",
        btnEmail: "‚úâÔ∏è Enviar pedido",
        lbClose: "Fechar",

        missingData: "Faltam dados do cliente:",
        noQty: "Ainda n√£o h√° quantidades selecionadas.",

        // Labels
        type: "Tipo",
        family: "Fam√≠lia",
        sizes: "Tamanhos",
        lineSubtotal: "Subtotal da linha",

        // Email/PDF
        orderSubjectPrefix: "PEDIDO AW26/27",
        appGenerated: "PEDIDO (gerado pela app)",
        dateTime: "Data e hora",
        clientDataBlock: "DADOS DO CLIENTE",
        orderDetails: "DETALHE DO PEDIDO",
        price: "Pre√ßo",
        subtotal: "Subtotal",
        units: "Unid",
        totalUnits: "TOTAL UNIDADES",
        totalEUR: "TOTAL ‚Ç¨",
        thanks: "Muito obrigado",
        confirm: "Aguardamos confirma√ß√£o do pedido",
        pdfTitle: "ABUELA TATA ¬∑ INVERNO AW 26/27",
        obs: "Obs",
        noPhoto: "Sem foto"
      }
    };

    function t(key){
      const pack = translations[currentLang] || translations.es;
      return pack[key] ?? (translations.es[key] ?? key);
    }

    function localeForLang(){
      if(currentLang === "en") return "en-GB";
      if(currentLang === "pt") return "pt-PT";
      return "es-ES";
    }

    function setLanguage(lang){
      currentLang = (lang === "en" || lang === "pt" || lang === "es") ? lang : "es";

      document.documentElement.lang = currentLang;
      document.getElementById("ui_title").textContent = t("title");
      document.getElementById("ui_subtitle").textContent = t("subtitle");
      document.getElementById("q").placeholder = t("search");

      document.getElementById("ui_clientTitle").textContent = t("clientTitle");
      document.getElementById("ui_clientHint").textContent = t("clientHint");

      document.getElementById("ui_lbl_name").textContent = t("lbl_name");
      document.getElementById("ui_lbl_vat").textContent = t("lbl_vat");
      document.getElementById("ui_lbl_email").textContent = t("lbl_email");
      document.getElementById("ui_lbl_cp").textContent = t("lbl_cp");
      document.getElementById("ui_lbl_city").textContent = t("lbl_city");
      document.getElementById("ui_lbl_notes").textContent = t("lbl_notes");

      document.getElementById("c_name").placeholder = t("ph_name");
      document.getElementById("c_vat").placeholder = t("ph_vat");
      document.getElementById("c_email").placeholder = t("ph_email");
      document.getElementById("c_cp").placeholder = t("ph_cp");
      document.getElementById("c_city").placeholder = t("ph_city");
      document.getElementById("c_notes").placeholder = t("ph_notes");

      document.getElementById("ui_offlineTitle").textContent = t("offlineTitle");
      document.getElementById("ui_offlineHint").textContent = t("offlineHint");
      document.getElementById("ui_offlineLabel").textContent = t("offlineLabel");

      document.getElementById("ui_pill_products").childNodes[0].textContent = t("pill_products") + " ";
      document.getElementById("ui_pill_lines").childNodes[0].textContent = t("pill_lines") + " ";

      document.getElementById("ui_unitsLabel").childNodes[0].textContent = t("unitsLabel") + " ";
      document.getElementById("ui_totalLabel").childNodes[0].textContent = t("totalLabel") + " ";

      document.getElementById("btnClear").textContent = t("btnClear");
      document.getElementById("btnPDF").textContent = t("btnPDF");
      document.getElementById("btnEmail").textContent = t("btnEmail");

      document.getElementById("lbClose").textContent = t("lbClose");

      refreshTotals();
    }

    function setActiveFlag(lang){
      document.querySelectorAll(".flagBtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.lang === lang);
      });
    }

    // =============================
    // Reglas de tallas
    // =============================
    const SIZES_11   = ["3m","6m","9m","12m","18m","2a"];
    const SIZES_BEBE = ["3m","6m","9m","18m","2a","3a","4a"];
    const SIZES_NINO = ["12m","18m","2a","3a","4a","5a","6a","8a","10a","12a"];
    const SIZES_UNICA = ["√öNICA"];

    // TIPO = 2 primeras, FAMILIA = 3 √∫ltimas
    function typeFromRef(ref){
      const s = String(ref || "").trim();
      if (s.length < 2) return "";
      return s.slice(0,2);
    }
    function familyFromRef(ref){
      const s = String(ref || "").trim();
      if (s.length < 3) return "";
      return s.slice(-3);
    }

    function sizesForType(type){
      if (type === "11") return SIZES_11;                        // pelele
      if (["12","13","31","30"].includes(type)) return SIZES_BEBE;
      if (["25","22","43"].includes(type)) return SIZES_NINO;
      if (["08"].includes(type)) return SIZES_UNICA;
      return SIZES_NINO;
    }

    // ----- Estado del pedido -----
    const order = Object.create(null);
    function getQty(ref, size){
      return (order[ref] && order[ref][size]) ? order[ref][size] : 0;
    }
    function setQty(ref, size, qty){
      if (!order[ref]) order[ref] = Object.create(null);
      order[ref][size] = Math.max(0, Number(qty) || 0);
      if (order[ref][size] === 0) delete order[ref][size];
      if (Object.keys(order[ref]).length === 0) delete order[ref];
      refreshTotals();
    }

    function formatEUR(n){
      const v = Number(n) || 0;
      return v.toLocaleString(localeForLang(), {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function nowSpain(){
      return new Date().toLocaleString("es-ES", {
        timeZone: "Europe/Madrid",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }

    // ----- Datos del cliente -----
    function getClientData(){
      return {
        name: document.getElementById("c_name").value.trim(),
        vat: document.getElementById("c_vat").value.trim(),
        cp: document.getElementById("c_cp").value.trim(),
        city: document.getElementById("c_city").value.trim(),
        email: document.getElementById("c_email").value.trim(),
        notes: document.getElementById("c_notes").value.trim()
      };
    }
    function validateClientData(){
      const c = getClientData();
      const missing = [];
      if(!c.name) missing.push(t("lbl_name").replace(" *",""));
      if(!c.vat) missing.push(t("lbl_vat").replace(" *",""));
      if(!c.cp) missing.push(t("lbl_cp").replace(" *",""));
      if(!c.city) missing.push(t("lbl_city").replace(" *",""));
      if(!c.email) missing.push(t("lbl_email").replace(" *",""));
      return missing;
    }

    // ----- Carga de tarifa.json -----
    const grid = document.getElementById("grid");
    const q = document.getElementById("q");
    const countEl = document.getElementById("count");
    const linesEl = document.getElementById("lines");
    const errEl = document.getElementById("err");
    let productos = [];

    async function loadTarifa(){
      try{
        errEl.style.display = "none";
        const url = "./data/tarifa.json?v=" + Date.now();
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) throw new Error("No puedo leer tarifa.json (HTTP " + res.status + ").");
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error("tarifa.json debe ser un array [ {ref,name,price}, ... ].");

        productos = data
          .filter(x => x && (x.ref || x.name))
          .map(x => ({
            ref: String(x.ref ?? "").trim(),
            name: String(x.name ?? "").trim(),
            price: Number(x.price ?? 0)
          }))
          .filter(x => x.ref.length > 0);

        countEl.textContent = productos.length;
        render();
      }catch(e){
        errEl.textContent = "‚ö†Ô∏è " + (e && e.message ? e.message : "Error cargando tarifa.json");
        errEl.style.display = "block";
      }
    }

    // ----- Lightbox -----
    const lb = document.getElementById("lb");
    const lbImg = document.getElementById("lbImg");
    const lbTitle = document.getElementById("lbTitle");
    document.getElementById("lbClose").addEventListener("click", ()=> lb.style.display="none");
    lb.addEventListener("click", (e)=>{ if(e.target === lb) lb.style.display="none"; });

    function openLightbox(ref, name, src){
      lbTitle.textContent = `${ref} ‚Äî ${name || ""}`.trim();
      lbImg.src = src;
      lb.style.display = "flex";
    }

    // ----- Render -----
    function render(){
      const term = (q.value || "").trim().toLowerCase();
      const list = term
        ? productos.filter(p => p.ref.toLowerCase().includes(term) || p.name.toLowerCase().includes(term))
        : productos;

      grid.innerHTML = "";
      for(const p of list){
        grid.appendChild(cardFor(p));
      }
      refreshTotals();
    }

    function cardFor(p){
      const type = typeFromRef(p.ref);
      const fam3 = familyFromRef(p.ref);
      const sizes = sizesForType(type);

      const card = document.createElement("div");
      card.className = "card";

      const top = document.createElement("div");
      top.className = "cardTop";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.title = "Pulsa para agrandar";

      const img = document.createElement("img");
      img.src = `images/${p.ref}.jpg`;
      img.alt = p.ref;

      let triedSecond = false;
      img.onerror = () => {
        if (!triedSecond){
          triedSecond = true;
          img.src = `${p.ref}.jpg`;
          return;
        }
        thumb.innerHTML = `<div class="ph">${p.ref}</div>`;
      };

      thumb.addEventListener("click", () => {
        if(!img || !img.src) return;
        openLightbox(p.ref, p.name, img.src);
      });

      thumb.appendChild(img);

      const info = document.createElement("div");
      info.className = "info";

      const row1 = document.createElement("div");
      row1.className = "row1";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const ref = document.createElement("div");
      ref.className = "ref";
      ref.textContent = p.ref;

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.name || "‚Äî";

      left.appendChild(ref);
      left.appendChild(name);

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = (Number(p.price)||0).toFixed(2).replace(".", ",") + " ‚Ç¨";

      row1.appendChild(left);
      row1.appendChild(price);
      info.appendChild(row1);

      top.appendChild(thumb);
      top.appendChild(info);

      const sizesBox = document.createElement("div");
      sizesBox.className = "sizes";

      const sh = document.createElement("div");
      sh.className = "sizesHeader";
      sh.innerHTML =
        `<span>${t("type")}: <strong>${type || "‚Äî"}</strong> ¬∑ ${t("family")}: <strong>${fam3 || "‚Äî"}</strong></span>` +
        `<span>${t("sizes")}: <strong>${sizes.length}</strong></span>`;

      const sg = document.createElement("div");
      sg.className = "sizesGrid";

      sizes.forEach(size => {
        const line = document.createElement("div");
        line.className = "sizeLine";

        const tag = document.createElement("div");
        tag.className = "sizeTag";
        tag.textContent = size;

        const stepper = document.createElement("div");
        stepper.className = "stepper";

        const minus = document.createElement("button");
        minus.type = "button";
        minus.className = "btn";
        minus.textContent = "‚àí";

        const input = document.createElement("input");
        input.className = "qty";
        input.type = "number";
        input.inputMode = "numeric";
        input.min = "0";
        input.step = "1";
        input.value = String(getQty(p.ref, size));

        const plus = document.createElement("button");
        plus.type = "button";
        plus.className = "btn";
        plus.textContent = "+";

        minus.addEventListener("click", () => {
          const v = Math.max(0, (Number(input.value)||0) - 1);
          input.value = String(v);
          setQty(p.ref, size, v);
          refreshLineTotal(card, p);
        });

        plus.addEventListener("click", () => {
          const v = (Number(input.value)||0) + 1;
          input.value = String(v);
          setQty(p.ref, size, v);
          refreshLineTotal(card, p);
        });

        input.addEventListener("change", () => {
          const v = Math.max(0, Number(input.value)||0);
          input.value = String(v);
          setQty(p.ref, size, v);
          refreshLineTotal(card, p);
        });

        stepper.appendChild(minus);
        stepper.appendChild(input);
        stepper.appendChild(plus);

        line.appendChild(tag);
        line.appendChild(stepper);

        sg.appendChild(line);
      });

      const lt = document.createElement("div");
      lt.className = "lineTotal";
      lt.innerHTML = `<span>${t("lineSubtotal")}</span><strong data-subtotal>0,00 ‚Ç¨ ¬∑ 0 uds</strong>`;

      sizesBox.appendChild(sh);
      sizesBox.appendChild(sg);
      sizesBox.appendChild(lt);

      card.appendChild(top);
      card.appendChild(sizesBox);

      refreshLineTotal(card, p);
      return card;
    }

    function refreshLineTotal(card, p){
      const ref = p.ref;
      const type = typeFromRef(ref);
      const sizes = sizesForType(type);

      let units = 0;
      for(const s of sizes) units += getQty(ref, s);

      const subtotal = units * (Number(p.price)||0);

      const el = card.querySelector("[data-subtotal]");
      if (el){
        el.textContent = `${formatEUR(subtotal)} ‚Ç¨ ¬∑ ${units} ${t("units")}`;
      }
    }

    function refreshTotals(){
      let units = 0;
      let total = 0;
      let linesWithQty = 0;

      const priceByRef = new Map(productos.map(p => [p.ref, Number(p.price)||0]));

      for(const ref of Object.keys(order)){
        let refUnits = 0;
        for(const s of Object.keys(order[ref])){
          const q = Number(order[ref][s])||0;
          refUnits += q;
          units += q;
        }
        if (refUnits > 0) linesWithQty += 1;
        total += refUnits * (priceByRef.get(ref) || 0);
      }

      document.getElementById("u").textContent = units;
      document.getElementById("t").textContent = formatEUR(total);
      linesEl.textContent = linesWithQty;
    }

    function buildOrderLines(){
      const priceByRef = new Map(productos.map(p => [p.ref, p]));
      const refs = Object.keys(order).sort();
      const lines = [];

      for(const ref of refs){
        const prod = priceByRef.get(ref);
        if(!prod) continue;

        const type = typeFromRef(ref);
        const fam3 = familyFromRef(ref);
        const sizes = sizesForType(type);

        let units = 0;
        const parts = [];
        for(const s of sizes){
          const q = getQty(ref, s);
          if(q > 0){
            parts.push(`${s}:${q}`);
            units += q;
          }
        }
        if(units === 0) continue;

        const price = Number(prod.price)||0;
        const subtotal = units * price;

        lines.push({
          ref,
          name: prod.name || "",
          price,
          units,
          subtotal,
          sizesText: parts.join("  "),
          type,
          fam3
        });
      }
      return lines;
    }

    // --- Email a info@abuelatata.com (mailto) ---
    function sendOrderEmail(){
      const missing = validateClientData();
      if(missing.length){
        alert(t("missingData") + "\n- " + missing.join("\n- "));
        return;
      }

      const lines = buildOrderLines();
      if(lines.length === 0){
        alert(t("noQty"));
        return;
      }

      const c = getClientData();
      const dateTime = nowSpain();

      let totalUnits = 0;
      let totalEUR = 0;
      lines.forEach(l => { totalUnits += l.units; totalEUR += l.subtotal; });

      const subject = `${t("orderSubjectPrefix")} ¬∑ ${c.name} ¬∑ ${dateTime}`;

      const bodyParts = [];
      bodyParts.push(t("pdfTitle"));
      bodyParts.push(t("appGenerated"));
      bodyParts.push("‚Äî");
      bodyParts.push(`${t("dateTime")}: ${dateTime}`);
      bodyParts.push("");
      bodyParts.push(t("clientDataBlock"));
      bodyParts.push(`${t("lbl_name").replace(" *","")}: ${c.name}`);
      bodyParts.push(`${t("lbl_vat").replace(" *","")}: ${c.vat}`);
      bodyParts.push(`${t("lbl_cp").replace(" *","")}: ${c.cp}`);
      bodyParts.push(`${t("lbl_city").replace(" *","")}: ${c.city}`);
      bodyParts.push(`${t("lbl_email").replace(" *","")}: ${c.email}`);
      if(c.notes) bodyParts.push(`${t("lbl_notes")}: ${c.notes}`);
      bodyParts.push("‚Äî");
      bodyParts.push(t("orderDetails"));

      for(const l of lines){
        bodyParts.push(`${l.ref} ‚Äî ${l.name}`);
        bodyParts.push(`  ${t("type")}: ${l.type} ¬∑ ${t("family")}: ${l.fam3}`);
        bodyParts.push(`  ${l.sizesText}`);
        bodyParts.push(`  ${t("price")}: ${formatEUR(l.price)} ‚Ç¨ ¬∑ ${t("subtotal")}: ${formatEUR(l.subtotal)} ‚Ç¨ ¬∑ ${t("units")}: ${l.units}`);
        bodyParts.push("");
      }

      bodyParts.push("‚Äî");
      bodyParts.push(`${t("totalUnits")}: ${totalUnits}`);
      bodyParts.push(`${t("totalEUR")}: ${formatEUR(totalEUR)} ‚Ç¨`);
      bodyParts.push("");
      bodyParts.push(t("thanks"));
      bodyParts.push(t("confirm"));

      const body = bodyParts.join("\n");

      const to = "info@abuelatata.com";
      const mailto = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
    }

    // --- PDF con fotos (solo l√≠neas con cantidades) ---
    async function fetchImageAsDataURL(url){
      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) return null;
        const blob = await res.blob();
        return await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => resolve(null);
          reader.readAsDataURL(blob);
        });
      }catch(e){
        return null;
      }
    }

    async function getBestProductImageDataURL(ref){
      let data = await fetchImageAsDataURL(`images/${ref}.jpg?v=${Date.now()}`);
      if (data) return data;
      data = await fetchImageAsDataURL(`${ref}.jpg?v=${Date.now()}`);
      if (data) return data;
      data = await fetchImageAsDataURL(`images/${ref}.png?v=${Date.now()}`);
      if (data) return data;
      data = await fetchImageAsDataURL(`${ref}.png?v=${Date.now()}`);
      if (data) return data;
      return null;
    }

    async function exportPDFWithImages(){
      const missing = validateClientData();
      if(missing.length){
        alert(t("missingData") + "\n- " + missing.join("\n- "));
        return;
      }

      const lines = buildOrderLines();
      if(lines.length === 0){
        alert(t("noQty"));
        return;
      }

      const c = getClientData();
      const dateTime = nowSpain();

      let totalUnits = 0;
      let totalEUR = 0;
      for(const l of lines){ totalUnits += l.units; totalEUR += l.subtotal; }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

      const margin = 12;
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.text(t("pdfTitle"), margin, 16);

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.text(`${t("dateTime")}: ${dateTime}`, margin, 23);
      doc.text(`${t("lbl_name").replace(" *","")}: ${c.name} ¬∑ ${t("lbl_vat").replace(" *","")}: ${c.vat}`, margin, 28);
      doc.text(`${t("lbl_cp").replace(" *","")}: ${c.cp} ¬∑ ${t("lbl_city").replace(" *","")}: ${c.city} ¬∑ ${t("lbl_email").replace(" *","")}: ${c.email}`, margin, 33);
      if(c.notes) doc.text(`${t("obs")}: ${c.notes}`, margin, 38);

      doc.setFont("helvetica","bold");
      doc.setFontSize(10);
      doc.text(`${t("unitsLabel").replace(":","")}: ${totalUnits}   ¬∑   ${t("totalLabel").replace(":","")}: ${formatEUR(totalEUR)} ‚Ç¨`, margin, 45);

      let y = 54;
      const rowH = 30;
      const imgBox = 22;
      const gap = 4;

      for(const l of lines){
        if(y + rowH > pageH - 12){
          doc.addPage();
          y = 16;
        }

        doc.setDrawColor(200);
        doc.setLineWidth(0.2);
        doc.roundedRect(margin, y-4, pageW - margin*2, rowH, 3, 3);

        const imgData = await getBestProductImageDataURL(l.ref);
        if(imgData){
          try{
            const isPng = String(imgData).startsWith("data:image/png");
            doc.addImage(imgData, isPng ? "PNG" : "JPEG", margin+2, y-2, imgBox, imgBox);
          }catch(e){}
        }else{
          doc.setFont("helvetica","bold");
          doc.setFontSize(8);
          doc.text(l.ref, margin+2, y+8);
          doc.setFont("helvetica","normal");
          doc.text(t("noPhoto"), margin+2, y+13);
        }

        const textX = margin + 2 + imgBox + gap;

        doc.setFont("helvetica","bold");
        doc.setFontSize(11);
        doc.text(`${l.ref}`, textX, y+4);

        doc.setFont("helvetica","normal");
        doc.setFontSize(9.5);
        const nameLines = doc.splitTextToSize(l.name, pageW - margin - textX - 2);
        doc.text(nameLines.slice(0,2), textX, y+9);

        doc.setFontSize(9);
        doc.text(`${t("type")}: ${l.type} ¬∑ ${t("family")}: ${l.fam3}`, textX, y+14);

        const sizesLines = doc.splitTextToSize(l.sizesText, pageW - margin - textX - 2);
        doc.text(sizesLines.slice(0,2), textX, y+19);

        doc.setFont("helvetica","bold");
        doc.setFontSize(10);
        const rightText = `${l.units} ${t("units")} ¬∑ ${formatEUR(l.subtotal)} ‚Ç¨`;
        doc.text(rightText, pageW - margin - doc.getTextWidth(rightText), y+24);

        y += rowH + 6;
      }

      const stamp = new Date().toISOString().slice(0,10);
      doc.save(`Order_AbuelaTata_AW26-27_${c.name.replace(/\s+/g,"_")}_${stamp}.pdf`);
    }

    // ----- Botones -----
    document.getElementById("btnEmail").addEventListener("click", sendOrderEmail);
    document.getElementById("btnPDF").addEventListener("click", exportPDFWithImages);

    document.getElementById("btnClear").addEventListener("click", () => {
      for (const k of Object.keys(order)) delete order[k];
      render();
    });

    q.addEventListener("input", () => render());

    // ----- Modo OFFLINE -----
    const offlineBox = document.getElementById("offlineBox");
    const tarifaFile = document.getElementById("tarifaFile");

    function setProductosFromJSON(data){
      if(!Array.isArray(data)) throw new Error("El JSON debe ser un array: [ {ref,name,price}, ... ]");

      productos = data
        .filter(x => x && (x.ref || x.name))
        .map(x => ({
          ref: String(x.ref ?? "").trim(),
          name: String(x.name ?? "").trim(),
          price: Number(x.price ?? 0)
        }))
        .filter(x => x.ref.length > 0);

      countEl.textContent = productos.length;
      render();
    }

    function isFileProtocol(){
      return window.location.protocol === "file:";
    }

    if (isFileProtocol()){
      offlineBox.style.display = "block";
      errEl.style.display = "none";

      tarifaFile.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;

        try{
          const text = await file.text();
          const json = JSON.parse(text);
          setProductosFromJSON(json);
        }catch(err){
          alert("No he podido cargar la tarifa.json. Revisa que sea un JSON v√°lido.");
          console.error(err);
        }
      });
    }

    // =============================
    // Banderas + idioma inicial
    // =============================
    document.querySelectorAll(".flagBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const lang = btn.dataset.lang;
        setLanguage(lang);
        setActiveFlag(lang);
        try{ localStorage.setItem("lang", lang); }catch(e){}
        render(); // para que cambien Tipo/Familia/Tallas/Subtotal en tarjetas
      });
    });

    let saved = "es";
    try{ saved = localStorage.getItem("lang") || "es"; }catch(e){}
    setLanguage(saved);
    setActiveFlag(saved);

    // ----- Arranque -----
    loadTarifa();
  </script>
</body>
</html>
